<header th:fragment="header" xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

    <style>
        /* Header cố định chứa cả Topbar và Navbar */
        .smart-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1030;
            width: 100%;
            transition: transform 0.3s ease-in-out;
            background-color: white;
            /* Nền trắng để menu không bị trong suốt */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Class ẩn header (kéo lên trên) */
        .header-hidden {
            transform: translateY(-100%);
        }

        /* Class hiện header (trở về vị trí cũ) */
        .header-visible {
            transform: translateY(0);
        }

        /* Đẩy nội dung body xuống 110px (bằng chiều cao header) để không bị che */
        body {
            padding-top: 110px;
        }
    </style>

    <div id="mainHeader" class="smart-header header-visible">

        <div class="top-bar py-2 text-center">
            Nhập mã <span class="fw-bold text-warning">OPENING</span> giảm ngay 20% đơn đầu tiên!
        </div>

        <nav class="navbar navbar-expand-lg navbar-light bg-white">
            <div class="container">
                <a class="navbar-brand fw-bold" href="/home">SHOP OMG!</a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav mx-auto">
                        <li class="nav-item"><a class="nav-link" href="/home">Trang chủ</a></li>
                        <li class="nav-item"><a class="nav-link" th:href="@{/home(gender='Nam')}">Nam</a></li>
                        <li class="nav-item"><a class="nav-link" th:href="@{/home(gender='Nữ')}">Nữ</a></li>
                        <li class="nav-item"><a class="nav-link" th:href="@{/home(gender='Unisex')}">Unisex</a></li>
                        <li class="nav-item"><a class="nav-link text-danger fw-bold"
                                th:href="@{/home(sale=true)}">Sale</a></li>
                    </ul>

                    <div class="d-flex gap-3 align-items-center">
                        <form action="/home" method="get" class="d-none d-md-flex position-relative me-2">
                            <input type="text" name="keyword" th:value="${keyword}"
                                class="form-control form-control-sm rounded-pill ps-3 pe-5 border-dark"
                                placeholder="Tìm sản phẩm..." style="width: 200px;">

                            <input type="hidden" name="gender" th:value="${selectedGender}">
                            <input type="hidden" name="category" th:value="${selectedCategory}">
                            <input type="hidden" name="color" th:value="${selectedColor}">
                            <input type="hidden" name="sort" th:value="${selectedSort}">
                            <input type="hidden" name="min" th:value="${minPrice}">
                            <input type="hidden" name="max" th:value="${maxPrice}">
                            <input type="hidden" name="sale" th:value="${isSale}">

                            <button type="submit"
                                class="btn btn-sm position-absolute end-0 top-0 mt-1 me-2 border-0 bg-transparent">
                                <i class="fas fa-search text-dark"></i>
                            </button>
                        </form>

                        <a href="/cart" class="position-relative text-dark">
                            <i class="fas fa-shopping-bag fa-lg"></i>
                            <span th:if="${cartItemCount > 0}"
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                style="font-size: 0.6rem;" th:text="${cartItemCount}">0</span>
                        </a>

                        <div class="d-flex align-items-center border-start ps-3 ms-2">
                            <div sec:authorize="isAnonymous()" class="d-flex align-items-center">
                                <a th:href="@{/login}"
                                    class="btn btn-sm btn-outline-dark rounded-pill px-3 me-2 fw-bold">Đăng nhập</a>
                                <a th:href="@{/register}" class="btn btn-sm btn-dark rounded-pill px-3 fw-bold">Đăng
                                    ký</a>
                            </div>

                            <div sec:authorize="isAuthenticated()" class="dropdown">
                                <a class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle"
                                    href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <img th:if="${currentUser != null && currentUser.avatar != null}"
                                        th:src="${currentUser.avatar}" class="rounded-circle me-2"
                                        style="width:30px; height:30px; object-fit:cover; border: 1px solid #eee;"
                                        onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                                    <i th:unless="${currentUser != null && currentUser.avatar != null}"
                                        class="fas fa-user-circle fa-lg me-2"></i>
                                    <span class="small fw-bold"
                                        th:text="${currentUser != null} ? ${currentUser.username} : ${#authentication.name}">Tài
                                        khoản</span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                                    <li><a class="dropdown-item" href="/account/profile"><i
                                                class="fas fa-user me-2 text-muted"></i>Tài khoản</a></li>
                                    <li><a class="dropdown-item" href="/account/orders"><i
                                                class="fas fa-box me-2 text-muted"></i>Đơn hàng</a></li>
                                    <li><a class="dropdown-item" href="/account/reviews"><i
                                                class="fas fa-star me-2 text-muted"></i>Đánh giá</a></li>
                                    <li sec:authorize="hasRole('ADMIN')">
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li sec:authorize="hasRole('ADMIN')"><a class="dropdown-item text-primary fw-bold"
                                            href="/admin/dashboard"><i class="fas fa-chart-line me-2"></i>Quản lý</a>
                                    </li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li>
                                        <form th:action="@{/logout}" method="post" class="px-3 py-1">
                                            <button type="submit" class="btn btn-danger btn-sm w-100">Đăng xuất</button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let lastScrollTop = 0;
            const header = document.getElementById("mainHeader");

            window.addEventListener("scroll", function () {
                let scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                // Bỏ qua nếu cuộn chưa đủ 50px (để tránh giật khi ở đỉnh trang)
                if (Math.abs(scrollTop - lastScrollTop) < 5) return;

                if (scrollTop > lastScrollTop && scrollTop > 50) {
                    // Kéo xuống -> ẨN
                    header.classList.remove("header-visible");
                    header.classList.add("header-hidden");
                } else {
                    // Kéo lên -> HIỆN
                    header.classList.remove("header-hidden");
                    header.classList.add("header-visible");
                }

                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            });
        });
    </script>
</header>