<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: view(~{::title}, ~{::article})}">
<head>
    <title th:text="${pageTitle}">Chi tiết sản phẩm</title>
</head>
<body>
    <article class="container py-5">
        
        <style>
            .variant-label { 
                cursor: pointer; 
                user-select: none; 
                border: 1px solid #dee2e6; 
                transition: all 0.2s; 
                min-width: 40px; 
                text-align: center; 
            }

            /* Khi được chọn: Thêm !important để ép chữ thành màu trắng */
            .variant-input:checked + .variant-label { 
                background-color: #000 !important; 
                color: #fff !important; 
                border-color: #000 !important; 
                font-weight: bold; 
            }

            .variant-label.disabled { 
                opacity: 0.3; 
                pointer-events: none; 
                background: #f2f2f2; 
                color: #aaa !important; 
                border-color: #eee; 
                text-decoration: line-through; 
            }

            .color-dot { 
                width: 20px; 
                height: 20px; 
                border-radius: 50%; 
                display: inline-block; 
                border: 1px solid #ccc; 
                vertical-align: middle; 
                margin-right: 5px; 
            }
        </style>

        <div class="row" th:if="${product}">
            <div class="col-md-6 mb-4">
                <img th:src="@{${product.image}}" class="img-fluid rounded w-100" onerror="this.src='https://placehold.co/600x400'">
            </div>

            <div class="col-md-6">
                <h2 class="fw-bold" th:text="${product.name}"></h2>
                <h3 class="text-danger fw-bold my-3" 
                    th:text="${#numbers.formatDecimal(product.price * (100 - product.discount) / 100, 0, 'COMMA', 0, 'POINT')} + ' đ'"></h3>

                <form th:action="@{/cart/add}" method="post">
                    <input type="hidden" name="productId" th:value="${product.id}">
                    <input type="hidden" name="productVariantId" id="selectedVariantId" value="">
                    
                    <div class="mb-3" th:if="${not #lists.isEmpty(uniqueColors)}">
                        <label class="fw-bold d-block mb-2">Màu sắc:</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div th:each="color : ${uniqueColors}">
                                <input type="radio" name="color" th:id="'c_' + ${color}" th:value="${color}" 
                                       class="variant-input" hidden onclick="userSelectColor(this.value)">
                                <label th:for="'c_' + ${color}" th:id="'btn_c_' + ${color}" 
                                       class="variant-label btn btn-outline-light text-dark px-3 py-2 d-flex align-items-center">
                                    <span class="color-dot" th:if="${color == 'Đen'}" style="background: #000;"></span>
                                    <span class="color-dot" th:if="${color == 'Trắng'}" style="background: #fff;"></span>
                                    <span class="color-dot" th:if="${color == 'Đỏ'}" style="background: red;"></span>
                                    <span class="color-dot" th:if="${color == 'Xanh'}" style="background: blue;"></span>
                                    <span th:text="${color}"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3" th:if="${not #lists.isEmpty(uniqueSizes)}">
                        <label class="fw-bold d-block mb-2">Kích thước:</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div th:each="size : ${uniqueSizes}">
                                <input type="radio" name="size" th:id="'s_' + ${size}" th:value="${size}" 
                                       class="variant-input" hidden onclick="userSelectSize(this.value)">
                                <label th:for="'s_' + ${size}" th:id="'btn_s_' + ${size}" 
                                       class="variant-label btn btn-outline-light text-dark px-3 py-2" th:text="${size}"></label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div id="stockDisplay" class="fw-bold text-success mb-2">Vui lòng chọn phân loại</div>
                        <div class="d-flex gap-2">
                            <input type="number" name="quantity" id="qtyInput" class="form-control text-center" value="1" min="1" style="width: 70px;">
                            <button type="submit" id="buyBtn" class="btn btn-dark flex-grow-1" disabled>THÊM VÀO GIỎ</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <input type="hidden" id="data-variants" th:value="${jsonVariants}">

        <script>
            // 1. Lấy dữ liệu an toàn
            var rawData = document.getElementById('data-variants').value;
            var variants = [];
            try {
                variants = JSON.parse(rawData);
                console.log("Script đã chạy! Dữ liệu:", variants);
            } catch (e) {
                console.error("Lỗi đọc dữ liệu:", e);
            }

            var selColor = null;
            var selSize = null;

            function userSelectColor(color) {
                if(selColor === color) { 
                    selColor = null; 
                    document.getElementById('c_'+color).checked = false; 
                } else { 
                    selColor = color; 
                }
                checkStock();
            }

            function userSelectSize(size) {
                if(selSize === size) { 
                    selSize = null; 
                    document.getElementById('s_'+size).checked = false; 
                } else { 
                    selSize = size; 
                }
                checkStock();
            }

            function checkStock() {
                // Logic Size
                document.querySelectorAll('input[name="size"]').forEach(function(el) {
                    var s = el.value;
                    var btn = document.getElementById('btn_s_' + s);
                    var available = variants.some(function(v) {
                        return v.size == s && (!selColor || v.color == selColor) && v.quantity > 0;
                    });
                    if(available) btn.classList.remove('disabled'); else btn.classList.add('disabled');
                });

                // Logic Color
                document.querySelectorAll('input[name="color"]').forEach(function(el) {
                    var c = el.value;
                    var btn = document.getElementById('btn_c_' + c);
                    var available = variants.some(function(v) {
                        return v.color == c && (!selSize || v.size == selSize) && v.quantity > 0;
                    });
                    if(available) btn.classList.remove('disabled'); else btn.classList.add('disabled');
                });

                // Logic hiển thị
                var stock = 0;
                var msg = "Vui lòng chọn phân loại";
                var canBuy = false;
                var variantId = null;

                if(selColor && selSize) {
                    var v = variants.find(function(i) { return i.color == selColor && i.size == selSize; });
                    if(v) { 
                        stock = v.quantity; 
                        msg = "Kho: " + stock + " sản phẩm"; 
                        canBuy = true;
                        variantId = v.id; // Lưu variant ID
                    } else { 
                        msg = "Hết hàng biến thể này"; 
                    }
                } else if (selColor) {
                    stock = variants.filter(function(i) { return i.color == selColor; })
                                    .reduce(function(a,b) { return a + b.quantity; }, 0);
                    msg = "Màu " + selColor + ": Còn " + stock + " (Chọn size)";
                } else if (selSize) {
                    stock = variants.filter(function(i) { return i.size == selSize; })
                                    .reduce(function(a,b) { return a + b.quantity; }, 0);
                    msg = "Size " + selSize + ": Còn " + stock + " (Chọn màu)";
                } else {
                    stock = variants.reduce(function(a,b) { return a + b.quantity; }, 0);
                    if(stock > 0) msg = "Tổng kho: " + stock;
                }

                // Cập nhật hidden input variantId
                document.getElementById('selectedVariantId').value = variantId || '';

                document.getElementById('stockDisplay').innerText = msg;
                var btnBuy = document.getElementById('buyBtn');
                var qtyInput = document.getElementById('qtyInput');
                
                if(canBuy && stock > 0) {
                    btnBuy.disabled = false;
                    qtyInput.max = stock;
                    qtyInput.value = 1;
                } else {
                    btnBuy.disabled = true;
                }
            }
            
            // Chạy ngay khi tải xong
            checkStock();
        </script>

    </article> </body>
</html>