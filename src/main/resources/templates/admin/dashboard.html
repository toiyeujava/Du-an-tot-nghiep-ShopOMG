<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{fragments/admin-layout :: view(~{::title}, ~{::article})}">

<head>
    <title>Tổng quan - Admin</title>
</head>

<body>
    <article>
        <!-- Stats Cards - Real data from DashboardService -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div>
                        <h6 class="text-muted small fw-bold text-uppercase mb-1">Doanh thu tháng</h6>
                        <h3 class="fw-bold mb-0"
                            th:text="${#numbers.formatDecimal(monthlyRevenue/1000000, 0, 'COMMA', 1, 'POINT')}+'M'">0M
                        </h3>
                    </div>
                    <div class="icon-box bg-primary-soft"><i class="fas fa-dollar-sign"></i></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div>
                        <h6 class="text-muted small fw-bold text-uppercase mb-1">Đơn hàng chờ xử lý</h6>
                        <h3 class="fw-bold mb-0" th:text="${pendingOrders}">0</h3>
                    </div>
                    <div class="icon-box bg-success-soft"><i class="fas fa-shopping-bag"></i></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div>
                        <h6 class="text-muted small fw-bold text-uppercase mb-1">Khách hàng</h6>
                        <h3 class="fw-bold mb-0"
                            th:text="${totalCustomers >= 1000 ? #numbers.formatDecimal(totalCustomers/1000, 0, 'COMMA', 1, 'POINT')+'k' : totalCustomers}">
                            0</h3>
                    </div>
                    <div class="icon-box bg-warning-soft"><i class="fas fa-user-plus"></i></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div>
                        <h6 class="text-muted small fw-bold text-uppercase mb-1">Sản phẩm</h6>
                        <h3 class="fw-bold mb-0" th:text="${totalProducts}">0</h3>
                    </div>
                    <div class="icon-box bg-danger-soft"><i class="fas fa-box"></i></div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Revenue Chart -->
            <div class="col-lg-8 mb-4">
                <div class="card-box h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold m-0">Phân tích doanh thu</h5>
                        <select class="form-select form-select-sm w-auto border-0 bg-light">
                            <option>Tháng này</option>
                            <option>Năm nay</option>
                        </select>
                    </div>
                    <canvas id="revenueChart" height="150"></canvas>
                </div>
            </div>

            <!-- Pending Orders List -->
            <div class="col-lg-4 mb-4">
                <div class="card-box h-100">
                    <h5 class="fw-bold mb-4">Đơn chờ xử lý</h5>

                    <!-- Dynamic pending orders from database -->
                    <div th:if="${recentOrders != null and !recentOrders.isEmpty()}">
                        <div th:each="order, stat : ${recentOrders}" th:if="${stat.index < 5}"
                            class="d-flex align-items-center mb-3 p-3 rounded bg-light">
                            <div class="icon-box bg-white shadow-sm me-3" style="width:40px; height:40px">
                                <i class="fas fa-file-invoice text-warning"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="fw-bold mb-0" th:text="'#ORD-' + ${order.id}">Order</h6>
                                <small class="text-muted"
                                    th:text="${#temporals.format(order.orderDate, 'dd/MM HH:mm')}">Time</small>
                            </div>
                            <a th:href="@{/admin/orders/{id}(id=${order.id})}"
                                class="btn btn-sm btn-dark rounded-pill px-3">Xem</a>
                        </div>
                    </div>

                    <!-- Empty state -->
                    <div th:if="${recentOrders == null or recentOrders.isEmpty()}" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p class="mb-0">Không có đơn hàng chờ xử lý</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart initialization - main logic in /js/admin/admin.js -->
        <script th:inline="javascript">
            document.addEventListener("DOMContentLoaded", function () {
                const chartData = /*[[${revenueChartData}]]*/[];
                initRevenueChart(chartData);
            });
        </script>

        <!-- Chat Widget -->
        <div class="chat-btn-toggle" onclick="toggleChatBox()">
            <i class="fas fa-comments"></i>
        </div>

        <div class="chat-box-container" id="chatBox">
            <div class="chat-header">
                <span><i class="fas fa-headset me-2"></i>CSKH - ShopOMG</span>
                <button type="button" class="btn-close btn-close-white" onclick="toggleChatBox()"></button>
            </div>

            <div class="chat-body" id="chatBody">
                <div class="message bot">Xin chào! ShopOMG có thể giúp gì cho
                    bạn hôm nay?</div>
            </div>

            <div class="chat-footer">
                <input type="text" id="chatInput" class="form-control" placeholder="Nhập tin nhắn..."
                    onkeypress="handleEnter(event)">
                <button class="btn btn-primary" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>


        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

        <script th:src="@{/js/chat.js}"></script>
    </article>
</body>

</html>