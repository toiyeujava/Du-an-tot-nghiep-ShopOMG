<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{fragments/admin-layout :: view(~{::title}, ~{::article})}">

<head>
    <title>Đơn hàng - Admin</title>
</head>

<body>
    <article>
        <!-- Status Filter Buttons -->
        <div class="mb-4">
            <a th:href="@{/admin/orders}" th:classappend="${selectedStatus == null} ? 'btn-dark' : 'btn-white border'"
                class="btn rounded-pill px-4 me-2">Tất cả</a>
            <a th:href="@{/admin/orders(status='PENDING')}"
                th:classappend="${selectedStatus == 'PENDING'} ? 'btn-dark' : 'btn-white border'"
                class="btn rounded-pill px-4 me-2">
                Chờ xử lý
                <span class="badge bg-danger ms-2" th:text="${orderStats?.PENDING ?: 0}">0</span>
            </a>
            <a th:href="@{/admin/orders(status='SHIPPING')}"
                th:classappend="${selectedStatus == 'SHIPPING'} ? 'btn-dark' : 'btn-white border'"
                class="btn rounded-pill px-4 me-2">
                Đang giao
                <span th:if="${orderStats?.SHIPPING != null and orderStats.SHIPPING > 0}" class="badge bg-info ms-2"
                    th:text="${orderStats.SHIPPING}"></span>
            </a>
            <a th:href="@{/admin/orders(status='COMPLETED')}"
                th:classappend="${selectedStatus == 'COMPLETED'} ? 'btn-dark' : 'btn-white border'"
                class="btn rounded-pill px-4">Hoàn thành</a>
        </div>

        <!-- Orders Table -->
        <div class="card-box">
            <div class="table-responsive">
                <table class="table table-custom">
                    <thead>
                        <tr>
                            <th class="ps-4">Mã đơn</th>
                            <th>Khách hàng</th>
                            <th>Ngày đặt</th>
                            <th>Tổng tiền</th>
                            <th>Thanh toán</th>
                            <th>Trạng thái</th>
                            <th class="text-end pe-4">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic order rows -->
                        <tr th:each="order : ${orders}">
                            <td class="ps-4 fw-bold" th:text="'#ORD-' + ${order.id}">#ORD-001</td>
                            <td>
                                <div class="fw-bold text-dark"
                                    th:text="${order.receiverName ?: order.account?.username ?: 'N/A'}">Customer</div>
                                <div class="small text-muted"
                                    th:text="${order.receiverPhone ?: order.account?.phone ?: '---'}">Phone</div>
                            </td>
                            <td>
                                <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy')}">Date</span>
                                <br>
                                <small class="text-muted"
                                    th:text="${#temporals.format(order.orderDate, 'HH:mm')}">Time</small>
                            </td>
                            <td class="fw-bold text-primary"
                                th:text="${#numbers.formatDecimal(order.finalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0
                                ₫</td>
                            <td>
                                <span class="badge bg-light text-dark border"
                                    th:text="${order.paymentMethod ?: 'COD'}">COD</span>
                            </td>
                            <td>
                                <!-- Status badge with dynamic class -->
                                <span th:switch="${order.status}">
                                    <span th:case="'PENDING'" class="badge-light-warning fw-bold">Chờ xác nhận</span>
                                    <span th:case="'CONFIRMED'" class="badge-light-info fw-bold">Đã xác nhận</span>
                                    <span th:case="'SHIPPING'" class="badge-light-primary fw-bold">Đang giao</span>
                                    <span th:case="'COMPLETED'" class="badge-light-success fw-bold">Hoàn thành</span>
                                    <span th:case="'CANCELLED'" class="badge-light-danger fw-bold">Đã hủy</span>
                                    <span th:case="*" class="badge bg-secondary"
                                        th:text="${order.status}">Unknown</span>
                                </span>
                            </td>
                            <td class="text-end pe-4">
                                <!-- Action button based on status -->
                                <a th:if="${order.status == 'PENDING'}" th:href="@{/admin/orders/{id}(id=${order.id})}"
                                    class="btn btn-dark btn-sm rounded-pill px-3">Xử lý</a>
                                <a th:unless="${order.status == 'PENDING'}"
                                    th:href="@{/admin/orders/{id}(id=${order.id})}"
                                    class="btn btn-light btn-sm rounded-pill px-3 border">Chi tiết</a>
                            </td>
                        </tr>

                        <!-- Empty state -->
                        <tr th:if="${orders == null or orders.isEmpty()}">
                            <td colspan="7" class="text-center py-5 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p class="mb-0">Không có đơn hàng nào</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div th:if="${totalPages != null and totalPages > 1}"
                class="d-flex justify-content-between align-items-center pt-4 px-4">
                <small class="text-muted">
                    Hiển thị <span th:text="${orders.size()}">0</span> / <span th:text="${totalItems}">0</span> đơn hàng
                </small>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link"
                                th:href="@{/admin/orders(page=${currentPage - 1}, status=${selectedStatus})}">«</a>
                        </li>
                        <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}" class="page-item"
                            th:classappend="${i == currentPage} ? 'active'">
                            <a class="page-link" th:href="@{/admin/orders(page=${i}, status=${selectedStatus})}"
                                th:text="${i + 1}">1</a>
                        </li>
                        <li class="page-item" th:classappend="${currentPage >= totalPages - 1} ? 'disabled'">
                            <a class="page-link"
                                th:href="@{/admin/orders(page=${currentPage + 1}, status=${selectedStatus})}">»</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </article>
</body>

</html>