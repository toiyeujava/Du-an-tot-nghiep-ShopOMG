<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{fragments/admin-layout :: view(~{::title}, ~{::article})}">

<head>
    <title>Biến thể sản phẩm - Admin</title>
</head>

<body>
    <article>
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin/products}">Sản phẩm</a></li>
                <li class="breadcrumb-item active" th:text="${product.name}">Product Name</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold m-0" th:text="'Biến thể: ' + ${product.name}">Biến thể sản phẩm</h4>
                <small class="text-muted" th:text="'ID: #' + ${product.id}">ID</small>
            </div>
            <button class="btn btn-primary fw-bold" data-bs-toggle="modal" data-bs-target="#variantModal"
                onclick="openCreateModal()">
                <i class="fas fa-plus me-2"></i> Thêm biến thể
            </button>
        </div>

        <!-- Flash messages -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="card-box">
            <div class="table-responsive">
                <table class="table table-custom align-middle">
                    <thead>
                        <tr>
                            <th class="ps-4">SKU</th>
                            <th>Màu sắc</th>
                            <th>Kích thước</th>
                            <th>Số lượng tồn</th>
                            <th class="text-end pe-4">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic variant rows -->
                        <tr th:each="variant : ${variants}" th:id="'row-' + ${variant.id}">
                            <td class="ps-4">
                                <span class="fw-bold" th:text="${variant.sku ?: 'N/A'}">SKU001</span>
                            </td>
                            <td>
                                <span th:if="${variant.color}" class="badge"
                                    th:style="'background-color:' + ${variant.color} + '; color: white; padding: 5px 10px;'"
                                    th:text="${variant.color}">Color</span>
                                <span th:unless="${variant.color}" class="text-muted">---</span>
                            </td>
                            <td>
                                <span th:if="${variant.size}" class="badge bg-secondary"
                                    th:text="${variant.size}">Size</span>
                                <span th:unless="${variant.size}" class="text-muted">---</span>
                            </td>
                            <td>
                                <span
                                    th:class="${variant.quantity != null and variant.quantity > 0} ? 'badge-light-success fw-bold' : 'badge-light-danger fw-bold'"
                                    th:text="${variant.quantity ?: 0}">0</span>
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn-icon btn-icon-edit"
                                    th:attr="onclick='openEditModal(' + ${variant.id} + ', \'' + ${variant.sku} + '\', \'' + ${variant.color} + '\', \'' + ${variant.size} + '\', ' + ${variant.quantity ?: 0} + ')'">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <form
                                    th:action="@{/admin/products/{pid}/variants/{vid}/delete(pid=${product.id}, vid=${variant.id})}"
                                    method="post" class="d-inline">
                                    <button type="submit" class="btn-icon btn-icon-delete ms-1" title="Xóa"
                                        onclick="return confirm('Xóa biến thể này?')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>

                        <!-- Empty state -->
                        <tr th:if="${variants == null or variants.isEmpty()}">
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="fas fa-layer-group fa-3x mb-3"></i>
                                <p class="mb-0">Chưa có biến thể nào</p>
                                <button class="btn btn-primary mt-3" data-bs-toggle="modal"
                                    data-bs-target="#variantModal" onclick="openCreateModal()">
                                    <i class="fas fa-plus me-2"></i>Thêm biến thể đầu tiên
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Summary -->
            <div th:if="${variants != null and !variants.isEmpty()}" class="px-4 py-3 border-top">
                <div class="row text-center">
                    <div class="col">
                        <h5 class="fw-bold mb-0" th:text="${variants.size()}">0</h5>
                        <small class="text-muted">Tổng biến thể</small>
                    </div>
                    <div class="col">
                        <h5 class="fw-bold mb-0 text-primary"
                            th:text="${variants.stream().mapToInt(v -> v.quantity ?: 0).sum()}">0</h5>
                        <small class="text-muted">Tổng tồn kho</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Variant Modal for Create/Edit -->
        <div class="modal fade" id="variantModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Thêm biến thể mới</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form th:action="@{/admin/products/{id}/variants(id=${product.id})}" method="post" id="variantForm">
                        <input type="hidden" id="variantId" name="variantId">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">SKU</label>
                                <input type="text" class="form-control" id="sku" name="sku"
                                    placeholder="VD: SP001-RED-M">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Màu sắc</label>
                                    <input type="text" class="form-control" id="color" name="color"
                                        placeholder="VD: Đỏ, Xanh...">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Kích thước</label>
                                    <input type="text" class="form-control" id="size" name="size"
                                        placeholder="VD: S, M, L, XL...">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Số lượng tồn kho</label>
                                <input type="number" class="form-control" id="quantity" name="quantity" min="0"
                                    value="0" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Lưu
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Initialize VariantManager with product ID from Thymeleaf -->
        <script th:inline="javascript">
            // Wait for DOM to be ready before initializing
            document.addEventListener('DOMContentLoaded', function () {
                const productId = /*[[${product.id}]]*/ 0;
                console.log('[VariantManager] Initializing with productId:', productId);
                VariantManager.init(productId);

                // Set initial form action for create mode
                const form = document.getElementById('variantForm');
                if (form) {
                    form.action = '/admin/products/' + productId + '/variants';
                    console.log('[VariantManager] Form action set to:', form.action);
                }
            });

            // Wrapper functions for onclick handlers
            function openCreateModal() {
                console.log('[VariantManager] Opening create modal');
                VariantManager.openCreateModal();
            }
            function openEditModal(id, sku, color, size, quantity) {
                console.log('[VariantManager] Opening edit modal for variant:', id);
                VariantManager.openEditModal(id, sku, color, size, quantity);
            }
        </script>
    </article>
</body>

</html>