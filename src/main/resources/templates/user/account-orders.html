<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: view(~{::title}, ~{::article})}">

<head>
    <title>Đơn mua - ShopOMG</title>
</head>

<body>
    <article class="container py-5">
        <div class="row">
            <div class="col-lg-3 mb-4">
                <div th:replace="~{fragments/account-sidebar :: sidebar('orders')}"></div>
            </div>
            <div class="col-lg-9">
                <!-- Status Tabs -->
                <div class="bg-white border rounded mb-4">
                    <ul class="nav nav-tabs order-tabs border-0" id="orderTabs">
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center active" href="#" data-status="all">Tất cả</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="PENDING">Chờ xác nhận</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="CONFIRMED">Đã xác nhận</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="SHIPPING">Đang giao</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="COMPLETED">Đã hoàn thành</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="CANCELLED">Đã hủy</a>
                        </li>
                    </ul>
                </div>

                <!-- Orders List -->
                <div id="ordersContainer">

                    <div th:each="order : ${orders}" class="card-box p-0 overflow-hidden mb-4 order-card"
                        th:attr="data-status=${order.status}">

                        <!-- Order Status Header -->
                        <div class="bg-light px-4 py-2 border-bottom d-flex justify-content-between align-items-center">
                            <span class="fw-bold small text-muted">
                                <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy')}">25/12/2025</span>
                            </span>
                            <div>
                                <span th:if="${order.status == 'PENDING'}" class="badge bg-warning text-dark">CHỜ XÁC
                                    NHẬN</span>
                                <span th:if="${order.status == 'CONFIRMED'}" class="badge bg-info">ĐÃ XÁC NHẬN</span>
                                <span th:if="${order.status == 'SHIPPING'}" class="badge bg-primary">ĐANG GIAO</span>
                                <span th:if="${order.status == 'COMPLETED'}" class="badge bg-success">HOÀN THÀNH</span>
                                <span th:if="${order.status == 'CANCELLED'}" class="badge bg-danger">ĐÃ HỦY</span>
                            </div>
                        </div>

                        <!-- Expected Delivery / Status Info -->
                        <div class="px-4 py-3 bg-white border-bottom" th:if="${order.status == 'PENDING'}">
                            <div class="d-flex align-items-center text-muted">
                                <i class="fas fa-truck me-2"></i>
                                <span class="fw-bold text-success">Đang chờ xác nhận</span>
                            </div>
                        </div>
                        <div class="px-4 py-3 bg-white border-bottom" th:if="${order.status == 'SHIPPING'}">
                            <div class="d-flex align-items-center text-muted">
                                <i class="fas fa-truck me-2"></i>
                                <span class="fw-bold text-success">Đang giao</span>
                            </div>
                        </div>

                        <!-- Order Products -->
                        <div class="p-4">
                            <div th:each="detail : ${order.orderDetails}" class="d-flex align-items-center mb-3">
                                <a th:href="@{/product/{id}(id=${detail.productVariant.product.id})}"
                                    class="text-decoration-none d-flex align-items-center flex-grow-1 text-dark">
                                    <img th:src="@{${detail.productVariant.product.image}}" alt="Product"
                                        class="order-img rounded border">
                                    <div class="ms-3 flex-grow-1">
                                        <h6 class="mb-1 fw-bold" th:text="${detail.productName}">Tên sản phẩm</h6>
                                        <small class="text-muted">
                                            <span th:text="${detail.productVariant.color}">Màu</span> /
                                            <span th:text="${detail.productVariant.size}">Size</span> |
                                            x<span th:text="${detail.quantity}">1</span>
                                        </small>
                                    </div>
                                </a>
                                <div class="fw-bold"
                                    th:text="${#numbers.formatDecimal(detail.price, 0, 'COMMA', 0, 'POINT') + 'đ'}">
                                    200.000đ</div>
                            </div>
                        </div>

                        <!-- Order Footer -->
                        <div
                            class="px-4 py-3 border-top text-end bg-light d-flex justify-content-between align-items-center">
                            <div>
                                <!-- No cancel button for now as per user request to do it later -->
                            </div>
                            <div>
                                <span class="text-muted me-2">Tổng tiền:</span>
                                <span class="fw-bold text-danger fs-5"
                                    th:text="${#numbers.formatDecimal(order.finalAmount, 0, 'COMMA', 0, 'POINT') + 'đ'}">200.000đ</span>
                                <div class="mt-2 d-flex justify-content-end gap-2">
                                    <span th:if="${order.status == 'PENDING' || order.status == 'CONFIRMED'}">
                                        <button type="button" class="btn btn-outline-danger btn-sm px-4"
                                            th:onclick="'confirmCancel(' + ${order.id} + ')'">Hủy đơn</button>
                                    </span>
                                    <a th:href="@{/product/{id}(id=${order.orderDetails[0].productVariant.product.id})}"
                                        class="btn btn-dark btn-sm px-4">Mua lại</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- No Orders Message -->
                    <div th:if="${#lists.isEmpty(orders)}" class="text-center py-5 bg-white border rounded">
                        <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                        <h5>Bạn chưa có đơn hàng nào</h5>
                        <p class="text-muted">Hãy mua sắm ngay để nhận nhiều ưu đãi!</p>
                        <a href="/home" class="btn btn-primary mt-3">Tiếp tục mua sắm</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cancellation Confirmation Modal -->
        <div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header border-0 pb-0">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center p-4">
                        <div class="mb-3">
                            <i
                                class="fas fa-exclamation-circle fa-4x text-danger animate__animated animate__pulse animate__infinite"></i>
                        </div>
                        <h4 class="fw-bold mb-2">Hủy đơn hàng?</h4>
                        <p class="text-muted">Bạn có chắc chắn muốn hủy đơn hàng này không? Hành động này không thể hoàn
                            tác.</p>
                    </div>
                    <div class="modal-footer border-0 justify-content-center pb-4">
                        <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Đóng</button>
                        <form id="cancelForm" th:action="@{/account/orders/cancel}" method="post">
                            <input type="hidden" name="orderId" id="cancelOrderId">
                            <button type="submit" class="btn btn-danger px-4">Xác nhận hủy</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Modal -->
        <div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-sm">
                <div class="modal-content border-0 shadow">
                    <div class="modal-body text-center p-4">
                        <div id="notificationIcon" class="mb-3"></div>
                        <h5 id="notificationTitle" class="fw-bold mb-2"></h5>
                        <p id="notificationMessage" class="text-muted mb-0"></p>
                        <button type="button" class="btn btn-dark w-100 mt-4" data-bs-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <style>
            .status-tab {
                padding: 12px 20px;
                color: #666;
                text-decoration: none;
                border-bottom: 2px solid transparent;
                font-weight: 500;
            }

            .status-tab.active {
                color: #000;
                border-bottom-color: #000;
            }

            .order-tabs .nav-link {
                color: #666;
                border-radius: 0;
                border: none;
                border-bottom: 2px solid transparent;
                padding: 12px 0;
                font-size: 0.95rem;
            }

            .order-tabs .nav-link:hover {
                color: #000;
            }

            .order-tabs .nav-link.active {
                color: #0d6efd !important;
                border-bottom: 2px solid #0d6efd !important;
                background: none !important;
                font-weight: 600;
            }

            .order-img {
                width: 80px;
                height: 80px;
                object-fit: cover;
            }

            .order-card {
                transition: transform 0.2s;
            }

            .order-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }
        </style>

        <script>
            document.querySelectorAll('.order-tabs .nav-link').forEach(tab => {
                tab.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelectorAll('.order-tabs .nav-link').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    const status = this.getAttribute('data-status');
                    document.querySelectorAll('.order-card').forEach(card => {
                        const cardStatus = card.getAttribute('data-status');
                        if (status === 'all') {
                            // "Tất cả" excludes "CANCELLED" as per user request
                            card.style.display = cardStatus === 'CANCELLED' ? 'none' : 'block';
                        } else if (cardStatus === status) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });

            // Initial filter for "all" tab
            document.querySelector('.order-tabs .nav-link[data-status="all"]').click();

            // Function to open cancel modal
            function confirmCancel(orderId) {
                document.getElementById('cancelOrderId').value = orderId;
                const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
                modal.show();
            }

            // Success/Error Popups using Modal
            window.onload = function () {
                const successMsg = "[[${success}]]";
                const errorMsg = "[[${error}]]";

                if ((successMsg && successMsg !== "null" && successMsg !== "") ||
                    (errorMsg && errorMsg !== "null" && errorMsg !== "")) {

                    const title = successMsg ? "Thành công" : "Thông báo";
                    const message = successMsg ? successMsg : errorMsg;
                    const iconClass = successMsg ? "fa-check-circle text-success" : "fa-info-circle text-info";

                    document.getElementById('notificationTitle').innerText = title;
                    document.getElementById('notificationMessage').innerText = message;
                    document.getElementById('notificationIcon').innerHTML = `<i class="fas ${iconClass} fa-4x"></i>`;

                    const notifyModal = new bootstrap.Modal(document.getElementById('notificationModal'));
                    notifyModal.show();
                }
            };
        </script>
    </article>
</body>

</html>