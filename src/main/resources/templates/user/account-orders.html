<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: view(~{::title}, ~{::article})}">

<head>
    <title>Đơn mua - ShopOMG</title>
</head>

<body>
    <article class="container py-5">
        <div class="row">
            <div class="col-lg-3 mb-4">
                <div th:replace="~{fragments/account-sidebar :: sidebar('orders')}"></div>
            </div>
            <div class="col-lg-9">
                <!-- Status Tabs -->
                <div class="bg-white border rounded mb-4">
                    <ul class="nav nav-tabs order-tabs border-0" id="orderTabs">
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center active" href="#" data-status="all">Tất cả</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="PENDING">Chờ xác nhận</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="CONFIRMED">Đã xác nhận</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="SHIPPING">Đang giao</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="COMPLETED">Đã hoàn thành</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="CANCELLED">Đã hủy</a>
                        </li>
                    </ul>
                </div>

                <!-- Orders List -->
                <div id="ordersContainer">

                    <div th:each="order : ${orders}" class="card-box p-0 overflow-hidden mb-4 order-card"
                        th:attr="data-status=${order.status},data-order-id=${order.id}">

                        <!-- Order Status Header -->
                        <div class="bg-light px-4 py-2 border-bottom d-flex justify-content-between align-items-center">
                            <span class="fw-bold small text-muted">
                                <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy')}">25/12/2025</span>
                            </span>
                            <div>
                                <span th:if="${order.status == 'PENDING'}" class="badge bg-warning text-dark">CHỜ XÁC
                                    NHẬN</span>
                                <span th:if="${order.status == 'CONFIRMED'}" class="badge bg-info">ĐÃ XÁC NHẬN</span>
                                <span th:if="${order.status == 'SHIPPING'}" class="badge bg-primary">ĐANG GIAO</span>
                                <span th:if="${order.status == 'COMPLETED'}" class="badge bg-success">HOÀN THÀNH</span>
                                <span th:if="${order.status == 'CANCELLED'}" class="badge bg-danger">ĐÃ HỦY</span>
                            </div>
                        </div>

                        <!-- Expected Delivery / Status Info -->
                        <div class="px-4 py-3 bg-white border-bottom" th:if="${order.status == 'PENDING'}">
                            <div class="d-flex align-items-center text-muted">
                                <i class="fas fa-truck me-2"></i>
                                <span class="fw-bold text-success">Đang chờ xác nhận</span>
                            </div>
                        </div>
                        <div class="px-4 py-3 bg-white border-bottom shipping-status-bar"
                            th:if="${order.status == 'SHIPPING'}">
                            <div class="d-flex align-items-center text-muted">
                                <i class="fas fa-truck me-2"></i>
                                <span class="fw-bold text-success">Đang giao</span>
                            </div>
                        </div>

                        <!-- Order Products -->
                        <div class="p-4">
                            <div th:each="detail : ${order.orderDetails}" class="d-flex align-items-center mb-3">
                                <a th:href="@{/product/{id}(id=${detail.productVariant.product.id})}"
                                    class="text-decoration-none d-flex align-items-center flex-grow-1 text-dark">
                                    <img th:src="@{${detail.productVariant.product.image}}" alt="Product"
                                        class="order-img rounded border">
                                    <div class="ms-3 flex-grow-1">
                                        <h6 class="mb-1 fw-bold" th:text="${detail.productName}">Tên sản phẩm</h6>
                                        <small class="text-muted">
                                            <span th:text="${detail.productVariant.color}">Màu</span> /
                                            <span th:text="${detail.productVariant.size}">Size</span> |
                                            x<span th:text="${detail.quantity}">1</span>
                                        </small>
                                    </div>
                                </a>
                                <div class="fw-bold"
                                    th:text="${#numbers.formatDecimal(detail.price, 0, 'COMMA', 0, 'POINT') + 'đ'}">
                                    200.000đ</div>
                            </div>
                        </div>

                        <!-- Order Footer -->
                        <div
                            class="px-4 py-3 border-top text-end bg-light d-flex justify-content-between align-items-center">
                            <div>
                                <!-- No cancel button for now as per user request to do it later -->
                            </div>
                            <div>
                                <span class="text-muted me-2">Tổng tiền:</span>
                                <span class="fw-bold text-danger fs-5"
                                    th:text="${#numbers.formatDecimal(order.finalAmount, 0, 'COMMA', 0, 'POINT') + 'đ'}">200.000đ</span>
                                <div class="mt-2 d-flex justify-content-end gap-2">
                                    <span th:if="${order.status == 'PENDING' || order.status == 'CONFIRMED'}">
                                        <button type="button" class="btn btn-outline-danger btn-sm px-4"
                                            th:onclick="'confirmCancel(' + ${order.id} + ')'">Hủy đơn</button>
                                    </span>
                                    <a th:href="@{/product/{id}(id=${order.orderDetails[0].productVariant.product.id})}"
                                        class="btn btn-dark btn-sm px-4">Mua lại</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- No Orders Message -->
                    <div th:if="${#lists.isEmpty(orders)}" class="text-center py-5 bg-white border rounded">
                        <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                        <h5>Bạn chưa có đơn hàng nào</h5>
                        <p class="text-muted">Hãy mua sắm ngay để nhận nhiều ưu đãi!</p>
                        <a href="/home" class="btn btn-primary mt-3">Tiếp tục mua sắm</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cancellation Reason Modal -->
        <div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
                <div class="modal-content border-0 shadow" style="border-radius: 16px; overflow: hidden;">
                    <!-- Header -->
                    <div class="modal-header border-0 px-4 pt-4 pb-2 d-flex align-items-center justify-content-between">
                        <h5 class="fw-bold mb-0" style="font-size: 1.1rem;">Chọn lý do</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <!-- Reason List -->
                    <div class="modal-body px-4 py-2">
                        <div class="cancel-reasons">
                            <label
                                class="cancel-reason-item d-flex align-items-center justify-content-between py-3 border-bottom">
                                <span>Không cần nữa</span>
                                <input type="radio" name="cancelReason" value="Không cần nữa" class="reason-radio">
                            </label>
                            <label
                                class="cancel-reason-item d-flex align-items-center justify-content-between py-3 border-bottom">
                                <span>Cần thay đổi phương thức thanh toán</span>
                                <input type="radio" name="cancelReason" value="Cần thay đổi phương thức thanh toán"
                                    class="reason-radio">
                            </label>
                            <label
                                class="cancel-reason-item d-flex align-items-center justify-content-between py-3 border-bottom">
                                <span>Chi phí giao hàng cao</span>
                                <input type="radio" name="cancelReason" value="Chi phí giao hàng cao"
                                    class="reason-radio">
                            </label>
                            <label
                                class="cancel-reason-item d-flex align-items-center justify-content-between py-3 border-bottom">
                                <span>Có giá tốt hơn</span>
                                <input type="radio" name="cancelReason" value="Có giá tốt hơn" class="reason-radio">
                            </label>
                            <label
                                class="cancel-reason-item d-flex align-items-center justify-content-between py-3 border-bottom">
                                <span>Cần thay đổi địa chỉ giao hàng</span>
                                <input type="radio" name="cancelReason" value="Cần thay đổi địa chỉ giao hàng"
                                    class="reason-radio">
                            </label>
                            <label class="cancel-reason-item d-flex align-items-center justify-content-between py-3">
                                <span>Người bán không trả lời thắc mắc</span>
                                <input type="radio" name="cancelReason" value="Người bán không trả lời thắc mắc"
                                    class="reason-radio">
                            </label>
                        </div>
                    </div>

                    <!-- Footer: only Xong button -->
                    <div class="modal-footer border-0 px-4 pb-4 pt-2">
                        <form id="cancelForm" th:action="@{/account/orders/cancel}" method="post" class="w-100">
                            <input type="hidden" name="orderId" id="cancelOrderId">
                            <input type="hidden" name="cancelReason" id="cancelReasonInput">
                            <button type="submit" id="cancelSubmitBtn" class="btn w-100 py-2 fw-bold" disabled
                                style="border-radius: 24px; background: #ffb3ba; color: #c0392b; border: none; font-size: 1rem; transition: background 0.2s;">
                                Xong
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Modal -->
        <div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-sm">
                <div class="modal-content border-0 shadow">
                    <div class="modal-body text-center p-4">
                        <div id="notificationIcon" class="mb-3"></div>
                        <h5 id="notificationTitle" class="fw-bold mb-2"></h5>
                        <p id="notificationMessage" class="text-muted mb-0"></p>
                        <button type="button" class="btn btn-dark w-100 mt-4" data-bs-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <style>
            .status-tab {
                padding: 12px 20px;
                color: #666;
                text-decoration: none;
                border-bottom: 2px solid transparent;
                font-weight: 500;
            }

            .status-tab.active {
                color: #000;
                border-bottom-color: #000;
            }

            .order-tabs .nav-link {
                color: #666;
                border-radius: 0;
                border: none;
                border-bottom: 2px solid transparent;
                padding: 12px 0;
                font-size: 0.95rem;
            }

            .order-tabs .nav-link:hover {
                color: #000;
            }

            .order-tabs .nav-link.active {
                color: #0d6efd !important;
                border-bottom: 2px solid #0d6efd !important;
                background: none !important;
                font-weight: 600;
            }

            .order-img {
                width: 80px;
                height: 80px;
                object-fit: cover;
            }

            .order-card {
                transition: transform 0.2s;
            }

            .order-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }

            /* Cancel reason modal */
            .cancel-reason-item {
                cursor: pointer;
                transition: background 0.15s;
                border-radius: 6px;
                padding-left: 4px;
                padding-right: 4px;
            }

            .cancel-reason-item:hover {
                background: #f8f8f8;
            }

            .cancel-reason-item input.reason-radio {
                width: 20px;
                height: 20px;
                accent-color: #e74c3c;
                cursor: pointer;
                flex-shrink: 0;
            }
        </style>

        <script>
            document.querySelectorAll('.order-tabs .nav-link').forEach(tab => {
                tab.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelectorAll('.order-tabs .nav-link').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    const status = this.getAttribute('data-status');
                    document.querySelectorAll('.order-card').forEach(card => {
                        const cardStatus = card.getAttribute('data-status');
                        if (status === 'all') {
                            // "Tất cả" excludes "CANCELLED" as per user request
                            card.style.display = cardStatus === 'CANCELLED' ? 'none' : 'block';
                        } else if (cardStatus === status) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });

            // Initial filter for "all" tab
            document.querySelector('.order-tabs .nav-link[data-status="all"]').click();

            // Function to open cancel reason modal
            function confirmCancel(orderId) {
                document.getElementById('cancelOrderId').value = orderId;
                // Reset radio buttons and disable Xong button
                document.querySelectorAll('input[name="cancelReason"]').forEach(r => r.checked = false);
                document.getElementById('cancelReasonInput').value = '';
                const submitBtn = document.getElementById('cancelSubmitBtn');
                submitBtn.disabled = true;
                submitBtn.style.background = '#ffb3ba';
                submitBtn.style.color = '#c0392b';
                const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
                modal.show();
            }

            // Enable Xong when a reason is selected
            document.querySelectorAll('input[name="cancelReason"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    document.getElementById('cancelReasonInput').value = this.value;
                    const submitBtn = document.getElementById('cancelSubmitBtn');
                    submitBtn.disabled = false;
                    submitBtn.style.background = '#e74c3c';
                    submitBtn.style.color = '#fff';
                });
            });

            // ===== AUTO-REFRESH POLLING =====
            // Mapping status code → { label, badgeClass }
            const STATUS_MAP = {
                'PENDING': { label: 'CHỜ XÁC NHẬN', cls: 'bg-warning text-dark' },
                'CONFIRMED': { label: 'ĐÃ XÁC NHẬN', cls: 'bg-info' },
                'SHIPPING': { label: 'ĐANG GIAO', cls: 'bg-primary' },
                'COMPLETED': { label: 'HOÀN THÀNH', cls: 'bg-success' },
                'CANCELLED': { label: 'ĐÃ HỦY', cls: 'bg-danger' }
            };

            function showUpdateToast(count) {
                let toast = document.getElementById('statusUpdateToast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'statusUpdateToast';
                    toast.style.cssText = `
                        position: fixed; bottom: 24px; right: 24px; z-index: 9999;
                        background: #212529; color: #fff; padding: 12px 20px;
                        border-radius: 8px; font-size: 0.9rem;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        display: flex; align-items: center; gap: 10px;
                        animation: fadeInUp 0.3s ease;
                    `;
                    document.body.appendChild(toast);
                }
                toast.innerHTML = `<i class="fas fa-sync-alt"></i> ${count} đơn hàng vừa được cập nhật trạng thái`;
                toast.style.display = 'flex';
                clearTimeout(toast._hideTimer);
                toast._hideTimer = setTimeout(() => toast.style.display = 'none', 5000);
            }

            function reapplyCurrentTab() {
                const activeTab = document.querySelector('.order-tabs .nav-link.active');
                if (activeTab) activeTab.click();
            }

            function pollOrderStatuses() {
                fetch('/account/orders/statuses')
                    .then(res => {
                        if (!res.ok) return; // ignore auth errors silently
                        return res.json();
                    })
                    .then(data => {
                        if (!data) return;
                        let updatedCount = 0;

                        data.forEach(({ orderId, status }) => {
                            const card = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
                            if (!card) return;

                            const currentStatus = card.getAttribute('data-status');
                            if (currentStatus === status) return; // no change

                            // Update data-status
                            card.setAttribute('data-status', status);
                            updatedCount++;

                            // Update badge
                            const badge = card.querySelector('.badge');
                            const info = STATUS_MAP[status];
                            if (badge && info) {
                                badge.className = 'badge ' + info.cls;
                                badge.textContent = info.label;
                            }

                            // Update shipping info bar
                            const shippingBar = card.querySelector('.shipping-status-bar');
                            if (shippingBar) {
                                shippingBar.style.display = status === 'SHIPPING' ? '' : 'none';
                            }
                        });

                        if (updatedCount > 0) {
                            reapplyCurrentTab();
                            showUpdateToast(updatedCount);
                        }
                    })
                    .catch(() => { }); // fail silently
            }

            // Start polling every 30 seconds
            setInterval(pollOrderStatuses, 30000);

            // ===== SUCCESS/ERROR POPUPS =====
            // Success/Error Popups using Modal
            window.onload = function () {
                const successMsg = "[[${success}]]";
                const errorMsg = "[[${error}]]";

                if ((successMsg && successMsg !== "null" && successMsg !== "") ||
                    (errorMsg && errorMsg !== "null" && errorMsg !== "")) {

                    const title = successMsg ? "Thành công" : "Thông báo";
                    const message = successMsg ? successMsg : errorMsg;
                    const iconClass = successMsg ? "fa-check-circle text-success" : "fa-info-circle text-info";

                    document.getElementById('notificationTitle').innerText = title;
                    document.getElementById('notificationMessage').innerText = message;
                    document.getElementById('notificationIcon').innerHTML = `<i class="fas ${iconClass} fa-4x"></i>`;

                    const notifyModal = new bootstrap.Modal(document.getElementById('notificationModal'));
                    notifyModal.show();
                }
            };
        </script>
    </article>
</body>

</html>