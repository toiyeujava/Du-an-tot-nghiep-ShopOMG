<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: view(~{::title}, ~{::article})}">

<head>
    <title>Đơn mua - ShopOMG</title>
</head>

<body>
    <article class="container py-5">
        <div class="row">
            <div class="col-lg-3 mb-4">
                <div th:replace="~{fragments/account-sidebar :: sidebar('orders')}"></div>
            </div>
            <div class="col-lg-9">
                <!-- Status Tabs -->
                <div class="bg-white border rounded mb-4">
                    <ul class="nav nav-tabs order-tabs border-0" id="orderTabs">
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center active" href="#" data-status="all">Tất cả</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="PENDING">Chờ xác nhận</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="CONFIRMED">Đã xác nhận</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="SHIPPING">Đang giao</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="COMPLETED">Đã hoàn thành</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="NEED_REVIEW">Cần đánh giá</a>
                        </li>
                        <li class="nav-item flex-fill">
                            <a class="nav-link text-center" href="#" data-status="CANCELLED">Đã hủy</a>
                        </li>
                    </ul>
                </div>

                <!-- Orders List -->
                <div id="ordersContainer">

                    <div th:each="order : ${orders}" class="card-box p-0 overflow-hidden mb-4 order-card"
                        th:attr="data-status=${order.status},data-order-id=${order.id}">

                        <!-- Order Status Header -->
                        <div class="bg-light px-4 py-2 border-bottom d-flex justify-content-between align-items-center">
                            <span class="fw-bold small text-muted">
                                <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy')}">25/12/2025</span>
                            </span>
                            <div>
                                <span th:if="${order.status == 'PENDING'}" class="badge bg-warning text-dark">CHỜ XÁC
                                    NHẬN</span>
                                <span th:if="${order.status == 'CONFIRMED'}" class="badge bg-info">ĐÃ XÁC NHẬN</span>
                                <span th:if="${order.status == 'SHIPPING'}" class="badge bg-primary">ĐANG GIAO</span>
                                <span th:if="${order.status == 'COMPLETED'}" class="badge bg-success">HOÀN THÀNH</span>
                                <span th:if="${order.status == 'CANCELLED'}" class="badge bg-danger">ĐÃ HỦY</span>
                            </div>
                        </div>




                        <!-- Order Products -->
                        <div class="p-4">
                            <div th:each="detail : ${order.orderDetails}"
                                class="d-flex align-items-center mb-3 order-detail-item"
                                th:attr="data-product-id=${detail.productVariant.product.id},data-product-name=${detail.productName},data-product-image=${detail.productVariant.product.image},data-product-color=${detail.productVariant.color},data-product-size=${detail.productVariant.size},data-product-qty=${detail.quantity}">
                                <a th:href="@{/product/{id}(id=${detail.productVariant.product.id})}"
                                    class="text-decoration-none d-flex align-items-center flex-grow-1 text-dark">
                                    <img th:src="@{${detail.productVariant.product.image}}" alt="Product"
                                        class="order-img rounded border">
                                    <div class="ms-3 flex-grow-1">
                                        <h6 class="mb-1 fw-bold" th:text="${detail.productName}">Tên sản phẩm</h6>
                                        <small class="text-muted">
                                            <span th:text="${detail.productVariant.color}">Màu</span> /
                                            <span th:text="${detail.productVariant.size}">Size</span> |
                                            x<span th:text="${detail.quantity}">1</span>
                                        </small>
                                    </div>
                                </a>
                                <div class="fw-bold"
                                    th:text="${#numbers.formatDecimal(detail.price, 0, 'COMMA', 0, 'POINT') + 'đ'}">
                                    200.000đ</div>
                            </div>
                        </div>

                        <!-- Order Footer -->
                        <div
                            class="px-4 py-3 border-top text-end bg-light d-flex justify-content-between align-items-center">
                            <div>
                                <!-- No cancel button for now as per user request to do it later -->
                            </div>
                            <div>
                                <span class="text-muted me-2">Tổng tiền:</span>
                                <span class="fw-bold text-danger fs-5"
                                    th:text="${#numbers.formatDecimal(order.finalAmount, 0, 'COMMA', 0, 'POINT') + 'đ'}">200.000đ</span>
                                <div class="mt-2 d-flex justify-content-end gap-2">
                                    <span th:if="${order.status == 'PENDING' || order.status == 'CONFIRMED'}">
                                        <button type="button" class="btn btn-outline-danger btn-sm px-4"
                                            th:onclick="'confirmCancel(' + ${order.id} + ')'">Hủy đơn</button>
                                    </span>
                                    <span th:if="${order.status == 'COMPLETED'}">
                                        <button type="button" class="btn btn-warning btn-sm px-4 fw-bold review-btn"
                                            th:attr="data-order-id=${order.id}">
                                            <i class="fas fa-star me-1"></i>Đánh giá
                                        </button>
                                    </span>
                                    <a th:href="@{/product/{id}(id=${order.orderDetails[0].productVariant.product.id})}"
                                        class="btn btn-dark btn-sm px-4">Mua lại</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- No Orders Message -->
                    <div th:if="${#lists.isEmpty(orders)}" class="text-center py-5 bg-white border rounded">
                        <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                        <h5>Bạn chưa có đơn hàng nào</h5>
                        <p class="text-muted">Hãy mua sắm ngay để nhận nhiều ưu đãi!</p>
                        <a href="/home" class="btn btn-primary mt-3">Tiếp tục mua sắm</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cancellation Reason Modal -->
        <div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
                <div class="modal-content border-0 shadow" style="border-radius: 16px; overflow: hidden;">
                    <!-- Header -->
                    <div class="modal-header border-0 px-4 pt-4 pb-2 d-flex align-items-center justify-content-between">
                        <h5 class="fw-bold mb-0" style="font-size: 1.1rem;">Chọn lý do</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <!-- Reason List -->
                    <div class="modal-body px-4 py-2">
                        <div class="cancel-reasons">
                            <label
                                class="cancel-reason-item d-flex align-items-center justify-content-between py-3 border-bottom">
                                <span>Không cần nữa</span>
                                <input type="radio" name="cancelReason" value="Không cần nữa" class="reason-radio">
                            </label>
                            <label
                                class="cancel-reason-item d-flex align-items-center justify-content-between py-3 border-bottom">
                                <span>Cần thay đổi phương thức thanh toán</span>
                                <input type="radio" name="cancelReason" value="Cần thay đổi phương thức thanh toán"
                                    class="reason-radio">
                            </label>
                            <label
                                class="cancel-reason-item d-flex align-items-center justify-content-between py-3 border-bottom">
                                <span>Chi phí giao hàng cao</span>
                                <input type="radio" name="cancelReason" value="Chi phí giao hàng cao"
                                    class="reason-radio">
                            </label>
                            <label
                                class="cancel-reason-item d-flex align-items-center justify-content-between py-3 border-bottom">
                                <span>Có giá tốt hơn</span>
                                <input type="radio" name="cancelReason" value="Có giá tốt hơn" class="reason-radio">
                            </label>
                            <label
                                class="cancel-reason-item d-flex align-items-center justify-content-between py-3 border-bottom">
                                <span>Cần thay đổi địa chỉ giao hàng</span>
                                <input type="radio" name="cancelReason" value="Cần thay đổi địa chỉ giao hàng"
                                    class="reason-radio">
                            </label>
                            <label class="cancel-reason-item d-flex align-items-center justify-content-between py-3">
                                <span>Người bán không trả lời thắc mắc</span>
                                <input type="radio" name="cancelReason" value="Người bán không trả lời thắc mắc"
                                    class="reason-radio">
                            </label>
                        </div>
                    </div>

                    <!-- Footer: only Xong button -->
                    <div class="modal-footer border-0 px-4 pb-4 pt-2">
                        <form id="cancelForm" th:action="@{/account/orders/cancel}" method="post" class="w-100">
                            <input type="hidden" name="orderId" id="cancelOrderId">
                            <input type="hidden" name="cancelReason" id="cancelReasonInput">
                            <button type="submit" id="cancelSubmitBtn" class="btn w-100 py-2 fw-bold" disabled
                                style="border-radius: 24px; background: #ffb3ba; color: #c0392b; border: none; font-size: 1rem; transition: background 0.2s;">
                                Xong
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Modal -->
        <div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-sm">
                <div class="modal-content border-0 shadow">
                    <div class="modal-body text-center p-4">
                        <div id="notificationIcon" class="mb-3"></div>
                        <h5 id="notificationTitle" class="fw-bold mb-2"></h5>
                        <p id="notificationMessage" class="text-muted mb-0"></p>
                        <button type="button" class="btn btn-dark w-100 mt-4" data-bs-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== REVIEW MODAL ===== -->
        <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" style="max-width: 500px;">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">

                    <!-- Header -->
                    <div
                        class="modal-header border-0 px-4 pt-4 pb-3 position-relative d-flex align-items-center justify-content-center">
                        <button type="button" id="reviewBackBtn"
                            class="btn p-0 position-absolute start-0 ms-3 text-dark"
                            style="font-size: 1.3rem; line-height:1;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h5 class="fw-bold mb-0" style="font-size: 1.05rem;">Vi&#7871;t &#273;&#225;nh gi&#225;</h5>
                    </div>

                    <div class="modal-body px-4 pt-0 pb-4" style="max-height:80vh; overflow-y:auto;">

                        <!-- Product info list -->
                        <div id="reviewProductList" class="mb-4"></div>

                        <!-- Star Rating -->
                        <div class="text-center mb-2" id="reviewStarSection">
                            <div class="d-flex justify-content-center gap-3 mb-1" id="reviewStars">
                                <i class="star-icon far fa-star" data-star="1"
                                    style="font-size:2rem; cursor:pointer; color:#ccc; transition:color .15s;"></i>
                                <i class="star-icon far fa-star" data-star="2"
                                    style="font-size:2rem; cursor:pointer; color:#ccc; transition:color .15s;"></i>
                                <i class="star-icon far fa-star" data-star="3"
                                    style="font-size:2rem; cursor:pointer; color:#ccc; transition:color .15s;"></i>
                                <i class="star-icon far fa-star" data-star="4"
                                    style="font-size:2rem; cursor:pointer; color:#ccc; transition:color .15s;"></i>
                                <i class="star-icon far fa-star" data-star="5"
                                    style="font-size:2rem; cursor:pointer; color:#ccc; transition:color .15s;"></i>
                            </div>
                            <div id="starRequiredMsg" class="text-danger small mb-1"
                                style="display:none; font-weight:600;">&#272;&#226;y l&#224; m&#7909;c b&#7855;t
                                bu&#7897;c</div>
                            <div id="starLabel" class="fw-semibold mt-1" style="font-size: 0.92rem; color: #555;">
                                Ch&#7845;m &#273;i&#7875;m &#273;&#417;n h&#224;ng c&#7911;a b&#7841;n <span
                                    class="text-danger">*</span>
                            </div>
                        </div>

                        <hr class="my-3">

                        <!-- Text area -->
                        <div class="mb-3">
                            <label class="fw-semibold mb-2 d-block" style="font-size: 0.9rem;">Chia s&#7867; &#253;
                                ngh&#297; c&#7911;a b&#7841;n</label>
                            <div style="position: relative;">
                                <textarea id="reviewText" class="form-control bg-light border-0" rows="4"
                                    maxlength="300" placeholder="Chia s&#7867; &#253; ngh&#297; c&#7911;a b&#7841;n"
                                    style="resize: none; border-radius: 10px; font-size: 0.9rem; padding-bottom: 28px;"></textarea>
                                <span id="reviewCharCount"
                                    style="position:absolute; bottom:8px; right:12px; font-size: 0.78rem; color:#aaa;">0/300</span>
                            </div>
                        </div>

                        <!-- Media upload -->
                        <div class="mb-4">
                            <label class="fw-semibold mb-2 d-block" style="font-size: 0.9rem;">Th&#234;m &#7843;nh
                                ho&#7863;c video</label>
                            <div id="mediaUploadArea"
                                style="border: 2px dashed #ddd; border-radius: 10px; padding: 24px 16px; text-align: center; cursor: pointer; background: #fafafa; transition: border-color .2s;"
                                onclick="document.getElementById('reviewMediaInput').click()">
                                <i class="fas fa-camera fa-2x mb-2 d-block" style="color:#bbb;"></i>
                                <span style="color:#aaa; font-size: 0.88rem;">Th&#234;m &#7843;nh ho&#7863;c
                                    video</span>
                            </div>
                            <input type="file" id="reviewMediaInput" accept="image/*,video/*" multiple
                                style="display:none;">
                            <div id="reviewMediaPreview" class="d-flex flex-wrap gap-2 mt-3"></div>
                        </div>

                        <!-- Submit button -->
                        <button type="button" id="reviewSubmitBtn" class="btn w-100 fw-bold py-2"
                            style="border-radius: 24px; background: #ff3366; color: #fff; font-size: 1rem; border: none; letter-spacing: .5px;">
                            G&#7917;i
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirm-abandon modal (when user clicks back mid-review) -->
        <div class="modal fade" id="confirmAbandonModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered" style="max-width: 340px; z-index: 1060;">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
                    <div class="modal-body text-center px-4 pt-4 pb-3">
                        <!-- Illustration -->
                        <div class="mb-3" style="font-size: 4rem; line-height:1;">&#128203;&#10003;</div>
                        <h5 class="fw-bold mb-2" style="font-size: 1.05rem; line-height: 1.4;">
                            Ti&#7871;p t&#7909;c &#273;&#225;nh gi&#225; &#273;&#7875;<br>gi&#250;p nh&#7919;ng
                            ng&#432;&#7901;i kh&#225;c
                        </h5>
                        <p class="text-muted mb-4" style="font-size: 0.88rem;">
                            N&#7871;u b&#7841;n h&#7911;y b&#7887;, &#273;&#225;nh gi&#225; c&#7911;a b&#7841;n s&#7869;
                            kh&#244;ng l&#432;u l&#7841;i
                        </p>
                        <button type="button" id="abandonContinueBtn" class="btn w-100 fw-bold py-2 mb-2"
                            style="border-radius: 24px; background: #ff3366; color: #fff; border: none; font-size: 0.97rem;">
                            Ti&#7871;p t&#7909;c vi&#7871;t
                        </button>
                        <button type="button" id="abandonConfirmBtn" class="btn w-100 fw-semibold py-2"
                            style="border-radius: 24px; background: transparent; color: #555; border: none; font-size: 0.95rem;">
                            H&#7911;y b&#7887;
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Small "must rate" alert modal -->
        <div class="modal fade" id="mustRateModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" style="max-width: 320px;">
                <div class="modal-content border-0 shadow"
                    style="border-radius: 14px; overflow: hidden; background: rgba(30,30,30,0.9); color:#fff;">
                    <div class="modal-body text-center py-3 px-4">
                        <p class="mb-0 fw-semibold" style="font-size: 0.95rem;">&#272;&#7875; g&#7917;i, h&#227;y
                            th&#234;m &#273;&#225;nh gi&#225;</p>
                    </div>
                </div>
            </div>
        </div>

        <style>
            .status-tab {
                padding: 12px 20px;
                color: #666;
                text-decoration: none;
                border-bottom: 2px solid transparent;
                font-weight: 500;
            }

            .status-tab.active {
                color: #000;
                border-bottom-color: #000;
            }

            .order-tabs .nav-link {
                color: #666;
                border-radius: 0;
                border: none;
                border-bottom: 2px solid transparent;
                padding: 12px 0;
                font-size: 0.95rem;
            }

            .order-tabs .nav-link:hover {
                color: #000;
            }

            .order-tabs .nav-link.active {
                color: #0d6efd !important;
                border-bottom: 2px solid #0d6efd !important;
                background: none !important;
                font-weight: 600;
            }

            .order-img {
                width: 80px;
                height: 80px;
                object-fit: cover;
            }

            .order-card {
                transition: transform 0.2s;
            }

            .order-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }

            /* Cancel reason modal */
            .cancel-reason-item {
                cursor: pointer;
                transition: background 0.15s;
                border-radius: 6px;
                padding-left: 4px;
                padding-right: 4px;
            }

            .cancel-reason-item:hover {
                background: #f8f8f8;
            }

            .cancel-reason-item input.reason-radio {
                width: 20px;
                height: 20px;
                accent-color: #e74c3c;
                cursor: pointer;
                flex-shrink: 0;
            }

            /* ===== Review Modal CSS ===== */
            #reviewStars .star-icon:hover,
            #reviewStars .star-icon.hovered {
                color: #f5a623 !important;
            }

            #reviewStars .star-icon.selected {
                color: #f5a623 !important;
            }

            .review-product-item {
                display: flex;
                align-items: flex-start;
                gap: 12px;
                padding: 10px 0;
                border-bottom: 1px solid #f0f0f0;
            }

            .review-product-item:last-child {
                border-bottom: none;
            }

            .review-product-item img {
                width: 60px;
                height: 60px;
                object-fit: cover;
                border-radius: 8px;
                border: 1px solid #eee;
                flex-shrink: 0;
            }

            .review-media-thumb {
                width: 72px;
                height: 72px;
                object-fit: cover;
                border-radius: 8px;
                border: 1px solid #eee;
            }

            .review-media-thumb-wrapper {
                position: relative;
                display: inline-block;
            }

            .review-media-thumb-wrapper .remove-media {
                position: absolute;
                top: -6px;
                right: -6px;
                width: 20px;
                height: 20px;
                background: #333;
                color: #fff;
                border-radius: 50%;
                font-size: 11px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                line-height: 1;
            }

            #reviewModal .modal-header {
                min-height: 56px;
            }

            #reviewSubmitBtn:hover {
                filter: brightness(1.1);
            }
        </style>

        <script>
            document.querySelectorAll('.order-tabs .nav-link').forEach(tab => {
                tab.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelectorAll('.order-tabs .nav-link').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    const status = this.getAttribute('data-status');
                    document.querySelectorAll('.order-card').forEach(card => {
                        const cardStatus = card.getAttribute('data-status');
                        if (status === 'all') {
                            // "Tất cả" excludes "CANCELLED" as per user request
                            card.style.display = cardStatus === 'CANCELLED' ? 'none' : 'block';
                        } else if (status === 'NEED_REVIEW') {
                            // "Cần đánh giá" shows COMPLETED orders
                            card.style.display = cardStatus === 'COMPLETED' ? 'block' : 'none';
                        } else if (cardStatus === status) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });

            // Initial filter for "all" tab
            document.querySelector('.order-tabs .nav-link[data-status="all"]').click();

            // Function to open cancel reason modal
            function confirmCancel(orderId) {
                document.getElementById('cancelOrderId').value = orderId;
                // Reset radio buttons and disable Xong button
                document.querySelectorAll('input[name="cancelReason"]').forEach(r => r.checked = false);
                document.getElementById('cancelReasonInput').value = '';
                const submitBtn = document.getElementById('cancelSubmitBtn');
                submitBtn.disabled = true;
                submitBtn.style.background = '#ffb3ba';
                submitBtn.style.color = '#c0392b';
                const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
                modal.show();
            }

            // Enable Xong when a reason is selected
            document.querySelectorAll('input[name="cancelReason"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    document.getElementById('cancelReasonInput').value = this.value;
                    const submitBtn = document.getElementById('cancelSubmitBtn');
                    submitBtn.disabled = false;
                    submitBtn.style.background = '#e74c3c';
                    submitBtn.style.color = '#fff';
                });
            });

            // ===== AUTO-REFRESH POLLING =====
            // Mapping status code → { label, badgeClass }
            const STATUS_MAP = {
                'PENDING': { label: 'CHỜ XÁC NHẬN', cls: 'bg-warning text-dark' },
                'CONFIRMED': { label: 'ĐÃ XÁC NHẬN', cls: 'bg-info' },
                'SHIPPING': { label: 'ĐANG GIAO', cls: 'bg-primary' },
                'COMPLETED': { label: 'HOÀN THÀNH', cls: 'bg-success' },
                'CANCELLED': { label: 'ĐÃ HỦY', cls: 'bg-danger' }
            };

            function showUpdateToast(count) {
                let toast = document.getElementById('statusUpdateToast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'statusUpdateToast';
                    toast.style.cssText = `
                        position: fixed; bottom: 24px; right: 24px; z-index: 9999;
                        background: #212529; color: #fff; padding: 12px 20px;
                        border-radius: 8px; font-size: 0.9rem;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        display: flex; align-items: center; gap: 10px;
                        animation: fadeInUp 0.3s ease;
                    `;
                    document.body.appendChild(toast);
                }
                toast.innerHTML = `<i class="fas fa-sync-alt"></i> ${count} đơn hàng vừa được cập nhật trạng thái`;
                toast.style.display = 'flex';
                clearTimeout(toast._hideTimer);
                toast._hideTimer = setTimeout(() => toast.style.display = 'none', 5000);
            }

            function reapplyCurrentTab() {
                const activeTab = document.querySelector('.order-tabs .nav-link.active');
                if (activeTab) activeTab.click();
            }

            function pollOrderStatuses() {
                fetch('/account/orders/statuses')
                    .then(res => {
                        if (!res.ok) return; // ignore auth errors silently
                        return res.json();
                    })
                    .then(data => {
                        if (!data) return;
                        let updatedCount = 0;

                        data.forEach(({ orderId, status }) => {
                            const card = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
                            if (!card) return;

                            const currentStatus = card.getAttribute('data-status');
                            if (currentStatus === status) return; // no change

                            // Update data-status
                            card.setAttribute('data-status', status);
                            updatedCount++;

                            // Update badge
                            const badge = card.querySelector('.badge');
                            const info = STATUS_MAP[status];
                            if (badge && info) {
                                badge.className = 'badge ' + info.cls;
                                badge.textContent = info.label;
                            }

                            // Update shipping info bar
                            const shippingBar = card.querySelector('.shipping-status-bar');
                            if (shippingBar) {
                                shippingBar.style.display = status === 'SHIPPING' ? '' : 'none';
                            }
                        });

                        if (updatedCount > 0) {
                            reapplyCurrentTab();
                            showUpdateToast(updatedCount);
                        }
                    })
                    .catch(() => { }); // fail silently
            }

            // Start polling every 30 seconds
            setInterval(pollOrderStatuses, 30000);

            // ===== SUCCESS/ERROR POPUPS =====
            // Success/Error Popups using Modal
            window.onload = function () {
                const successMsg = "[[${success}]]";
                const errorMsg = "[[${error}]]";

                if ((successMsg && successMsg !== "null" && successMsg !== "") ||
                    (errorMsg && errorMsg !== "null" && errorMsg !== "")) {

                    const title = successMsg ? "Thành công" : "Thông báo";
                    const message = successMsg ? successMsg : errorMsg;
                    const iconClass = successMsg ? "fa-check-circle text-success" : "fa-info-circle text-info";

                    document.getElementById('notificationTitle').innerText = title;
                    document.getElementById('notificationMessage').innerText = message;
                    document.getElementById('notificationIcon').innerHTML = `<i class="fas ${iconClass} fa-4x"></i>`;

                    const notifyModal = new bootstrap.Modal(document.getElementById('notificationModal'));
                    notifyModal.show();
                }
            };

            // ===== REVIEW MODAL =====
            const STAR_LABELS = ['Rất tệ', 'Tệ', 'Ổn', 'Tốt', 'Xuất sắc'];
            let currentStarValue = 0;
            let currentProductId = null;  // product ID sent to backend

            // Open review modal when "Đánh giá" button is clicked
            document.addEventListener('click', function (e) {
                const btn = e.target.closest('.review-btn');
                if (!btn) return;

                // Reset modal state
                currentStarValue = 0;
                document.querySelectorAll('.star-icon').forEach(s => {
                    s.classList.remove('selected', 'hovered');
                    s.style.color = '#ccc';
                });
                document.getElementById('starLabel').innerHTML = 'Chấm điểm đơn hàng của bạn <span class="text-danger">*</span>';
                document.getElementById('starRequiredMsg').style.display = 'none';
                document.getElementById('reviewText').value = '';
                document.getElementById('reviewCharCount').textContent = '0/300';
                document.getElementById('reviewMediaInput').value = '';
                document.getElementById('reviewMediaPreview').innerHTML = '';
                document.getElementById('mediaUploadArea').style.display = '';

                // Populate product list from parent order card
                const card = btn.closest('.order-card');
                const productList = document.getElementById('reviewProductList');
                productList.innerHTML = '';
                currentProductId = null;
                card.querySelectorAll('.order-detail-item').forEach((item, idx) => {
                    const productId = item.getAttribute('data-product-id') || '';
                    const name = item.getAttribute('data-product-name') || '';
                    const img = item.getAttribute('data-product-image') || '';
                    const color = item.getAttribute('data-product-color') || '';
                    const size = item.getAttribute('data-product-size') || '';
                    const qty = item.getAttribute('data-product-qty') || '';

                    // Use first product's ID for the review submission
                    if (idx === 0 && productId) currentProductId = parseInt(productId);

                    const el = document.createElement('div');
                    el.className = 'review-product-item';
                    el.innerHTML = `
                        <img src="${img}" alt="${name}" onerror="this.src='/images/placeholder.png'">
                        <div>
                            <div class="fw-semibold" style="font-size:.92rem; line-height:1.3;">${name}</div>
                            <div class="text-muted" style="font-size:.82rem; margin-top:3px;">${color} / ${size}, x${qty}</div>
                        </div>
                    `;
                    productList.appendChild(el);
                });

                const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
                modal.show();
            });

            // Star rating — hover
            document.querySelectorAll('.star-icon').forEach(star => {
                star.addEventListener('mouseenter', function () {
                    const hov = parseInt(this.getAttribute('data-star'));
                    document.querySelectorAll('.star-icon').forEach(s => {
                        const v = parseInt(s.getAttribute('data-star'));
                        s.style.color = v <= hov ? '#f5a623' : (v <= currentStarValue ? '#f5a623' : '#ccc');
                    });
                });
                star.addEventListener('mouseleave', function () {
                    document.querySelectorAll('.star-icon').forEach(s => {
                        const v = parseInt(s.getAttribute('data-star'));
                        s.style.color = v <= currentStarValue ? '#f5a623' : '#ccc';
                    });
                });
                star.addEventListener('click', function () {
                    currentStarValue = parseInt(this.getAttribute('data-star'));
                    document.querySelectorAll('.star-icon').forEach(s => {
                        const v = parseInt(s.getAttribute('data-star'));
                        s.style.color = v <= currentStarValue ? '#f5a623' : '#ccc';
                    });
                    document.getElementById('starLabel').innerHTML =
                        STAR_LABELS[currentStarValue - 1] + ' <span class="text-danger">*</span>';
                    document.getElementById('starRequiredMsg').style.display = 'none';
                });
            });

            // Char counter
            document.getElementById('reviewText').addEventListener('input', function () {
                document.getElementById('reviewCharCount').textContent = this.value.length + '/300';
            });

            // Media preview
            document.getElementById('reviewMediaInput').addEventListener('change', function () {
                const preview = document.getElementById('reviewMediaPreview');
                Array.from(this.files).forEach(file => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'review-media-thumb-wrapper';

                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.className = 'review-media-thumb';
                        const reader = new FileReader();
                        reader.onload = e => img.src = e.target.result;
                        reader.readAsDataURL(file);
                        wrapper.appendChild(img);
                    } else {
                        const vid = document.createElement('video');
                        vid.className = 'review-media-thumb';
                        vid.style.objectFit = 'cover';
                        const reader = new FileReader();
                        reader.onload = e => vid.src = e.target.result;
                        reader.readAsDataURL(file);
                        wrapper.appendChild(vid);
                    }

                    const removeBtn = document.createElement('span');
                    removeBtn.className = 'remove-media';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = () => wrapper.remove();
                    wrapper.appendChild(removeBtn);
                    preview.appendChild(wrapper);
                });

                // Hide the upload area when files are added, show a '+' tile instead
                if (preview.children.length > 0) {
                    document.getElementById('mediaUploadArea').style.display = 'none';
                    // Add a '+' tile to add more
                    let addMore = preview.querySelector('.add-more-tile');
                    if (!addMore) {
                        addMore = document.createElement('div');
                        addMore.className = 'add-more-tile review-media-thumb-wrapper';
                        addMore.style.cssText = 'width:72px;height:72px;border:2px dashed #ddd;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.5rem;color:#aaa;flex-shrink:0;';
                        addMore.innerHTML = '+';
                        addMore.onclick = () => document.getElementById('reviewMediaInput').click();
                        preview.appendChild(addMore);
                    }
                }
            });

            // Submit review
            document.getElementById('reviewSubmitBtn').addEventListener('click', function () {
                if (currentStarValue === 0) {
                    // Show required message
                    document.getElementById('starRequiredMsg').style.display = 'block';
                    // Show the small dark alert modal
                    const mustRateModal = new bootstrap.Modal(document.getElementById('mustRateModal'));
                    mustRateModal.show();
                    // Auto-hide after 2s
                    setTimeout(() => {
                        mustRateModal.hide();
                    }, 2000);
                    return;
                }

                // POST review to backend
                const submitBtn = document.getElementById('reviewSubmitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Đang gửi...';

                fetch('/account/reviews/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: currentProductId,
                        rating: currentStarValue,
                        comment: document.getElementById('reviewText').value.trim()
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
                            window.location.href = '/account/reviews';
                        } else {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Gửi';
                            alert(data.error || 'Đã xảy ra lỗi, vui lòng thử lại.');
                        }
                    })
                    .catch(() => {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Gửi';
                        alert('Lỗi kết nối, vui lòng thử lại.');
                    });
            });

            // ===== BACK BUTTON — abandon confirmation =====
            let abandonModal = null;

            document.getElementById('reviewBackBtn').addEventListener('click', function () {
                const hasContent = currentStarValue > 0 || document.getElementById('reviewText').value.trim().length > 0
                    || document.getElementById('reviewMediaPreview').children.length > 0;

                if (!hasContent) {
                    // Nothing typed — close immediately
                    bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
                    return;
                }

                // Show the abandon confirmation on top of the review modal
                abandonModal = new bootstrap.Modal(document.getElementById('confirmAbandonModal'));
                abandonModal.show();
            });

            // "Tiếp tục viết" — dismiss confirm only, keep review modal open
            document.getElementById('abandonContinueBtn').addEventListener('click', function () {
                if (abandonModal) { abandonModal.hide(); abandonModal = null; }
            });

            // "Hủy bỏ" — close both modals
            document.getElementById('abandonConfirmBtn').addEventListener('click', function () {
                if (abandonModal) { abandonModal.hide(); abandonModal = null; }
                const reviewModal = bootstrap.Modal.getInstance(document.getElementById('reviewModal'));
                if (reviewModal) reviewModal.hide();
            });

        </script>
    </article>
</body>

</html>