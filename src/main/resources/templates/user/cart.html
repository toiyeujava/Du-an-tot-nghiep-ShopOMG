<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: view(~{::title}, ~{::article})}">

<head>
    <title>Giỏ hàng - ShopOMG</title>
</head>

<body>
    <article class="container py-5">

        <!-- Progress Steps -->
        <div class="steps mb-5">
            <div class="step-item active">
                <div class="step-circle">1</div>
                Giỏ hàng
            </div>
            <div class="step-line"></div>
            <div class="step-item">
                <div class="step-circle">2</div>
                Thanh toán
            </div>
            <div class="step-line"></div>
            <div class="step-item">
                <div class="step-circle">3</div>
                Hoàn tất
            </div>
        </div>

        <!-- Flash Messages -->
        <!-- Success Toast (Slide In/Out) -->
        <div th:if="${success}" id="successToast" class="alert alert-success d-flex align-items-center shadow-lg"
            role="alert">
            <i class="bi bi-check-circle-fill me-2 fs-4"></i>
            <div>
                <strong class="d-block">Thành công!</strong>
                <span th:text="${success}"></span>
            </div>
            <button type="button" class="btn-close ms-auto" onclick="hideToast()"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Empty Cart State -->
        <div th:if="${#lists.isEmpty(cartItems)}" class="text-center py-5">
            <div class="mb-4">
                <i class="bi bi-cart-x" style="font-size: 5rem; color: #ddd;"></i>
            </div>
            <h4 class="mb-3">Giỏ hàng trống</h4>
            <p class="text-muted mb-4">Bạn chưa có sản phẩm nào trong giỏ hàng</p>
            <a href="/products" class="btn btn-dark px-4">Tiếp tục mua sắm</a>
        </div>

        <!-- Cart with Items -->
        <div th:if="${!#lists.isEmpty(cartItems)}" class="row">

            <!-- Cart Items Column -->
            <div class="col-lg-8 mb-4">
                <div class="card-box">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <label class="form-check-label fw-bold" for="selectAll">
                                Chọn tất cả (<span th:text="${itemCount}">0</span> sản phẩm)
                            </label>
                        </div>
                        <form id="clearCartForm" th:action="@{/cart/clear}" method="post" style="display: inline;">
                            <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                data-bs-target="#confirmClearModal">
                                <i class="bi bi-trash"></i> Xóa tất cả
                            </button>
                        </form>
                    </div>

                    <!-- Cart Item Card -->
                    <div th:each="item, iterStat : ${cartItems}" class="cart-item-card"
                        th:classappend="${!iterStat.last} ? 'border-bottom pb-3 mb-3' : ''">

                        <div class="row g-3 align-items-center">
                            <!-- Checkbox -->
                            <div class="col-auto">
                                <input class="form-check-input item-checkbox" type="checkbox"
                                    th:data-price="${item.productVariant.product.price * (100 - item.productVariant.product.discount) / 100}"
                                    th:data-qty="${item.quantity}" th:value="${item.id}" onchange="updateTotal()">
                            </div>

                            <!-- Product Image -->
                            <div class="col-auto">
                                <img th:src="@{${item.productVariant.product.image}}" class="cart-item-image rounded"
                                    onerror="this.src='https://placehold.co/100x100'">
                            </div>

                            <!-- Product Info -->
                            <div class="col">
                                <div class="d-flex justify-content-between">
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold mb-2" th:text="${item.productVariant.product.name}">Tên sản
                                            phẩm</h6>
                                        <div class="text-muted small mb-2">
                                            <span th:text="'Màu: ' + ${item.productVariant.color}">Màu: Đen</span>
                                            <span class="mx-2">|</span>
                                            <span th:text="'Size: ' + ${item.productVariant.size}">Size: M</span>
                                        </div>

                                        <!-- Price Display -->
                                        <div class="mb-3">
                                            <span class="text-danger fw-bold fs-5"
                                                th:text="${#numbers.formatDecimal(item.productVariant.product.price * (100 - item.productVariant.product.discount) / 100, 0, 'COMMA', 0, 'POINT')} + 'đ'">
                                                200.000đ
                                            </span>
                                            <span th:if="${item.productVariant.product.discount > 0}"
                                                class="text-muted text-decoration-line-through ms-2 small"
                                                th:text="${#numbers.formatDecimal(item.productVariant.product.price, 0, 'COMMA', 0, 'POINT')} + 'đ'">
                                                250.000đ
                                            </span>
                                        </div>

                                        <!-- Quantity Controls & Delete -->
                                        <!-- Quantity Controls & Delete -->
                                        <div class="d-flex align-items-center gap-3">
                                            <!-- Quantity Form -->
                                            <div class="quantity-controls d-flex align-items-center"
                                                th:data-max="${item.productVariant.quantity}"
                                                th:id="'qty-group-' + ${item.id}">

                                                <button type="button" class="btn btn-sm btn-light border"
                                                    th:onclick="'updateQuantity(' + ${item.id} + ', -1)'"
                                                    style="width: 36px; height: 36px;">
                                                    <i class="fas fa-minus text-dark" style="font-size: 0.8rem;"></i>
                                                </button>

                                                <span class="mx-3 fw-bold fs-5" th:id="'qty-' + ${item.id}"
                                                    th:text="${item.quantity}">1</span>

                                                <button type="button" class="btn btn-sm btn-light border"
                                                    th:onclick="'updateQuantity(' + ${item.id} + ', 1)'"
                                                    style="width: 36px; height: 36px;">
                                                    <i class="fas fa-plus text-dark" style="font-size: 0.8rem;"></i>
                                                </button>
                                            </div>

                                            <!-- Delete Button -->
                                            <form th:action="@{/cart/remove/{id}(id=${item.id})}" method="post"
                                                style="display: inline;">
                                                <button type="submit"
                                                    class="btn btn-sm btn-link text-danger text-decoration-none">
                                                    <i class="fas fa-trash-alt"></i> Xóa
                                                </button>
                                            </form>
                                        </div>

                                        <!-- Stock Warning -->
                                        <div th:id="'stock-warning-' + ${item.id}" class="text-warning small mt-2"
                                            th:classappend="${item.quantity >= item.productVariant.quantity} ? '' : 'd-none'">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Đã đạt số lượng tối đa trong kho
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Column -->
            <div class="col-lg-4">
                <div class="card-box sticky-summary">
                    <h5 class="fw-bold mb-4">Tổng cộng</h5>

                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Tạm tính:</span>
                        <span class="fw-bold" id="subTotalDisplay">0đ</span>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Phí vận chuyển:</span>
                        <span class="text-success fw-bold">Miễn phí</span>
                    </div>

                    <hr class="my-3">

                    <div class="d-flex justify-content-between mb-4">
                        <span class="fw-bold fs-5">Tổng thanh toán:</span>
                        <span class="text-danger fw-bold fs-4" id="finalTotalDisplay">0đ</span>
                    </div>

                    <div class="d-grid gap-2">
                        <button id="checkoutBtn" class="btn btn-secondary btn-lg fw-bold py-3" disabled
                            onclick="submitCheckout()">
                            THANH TOÁN (0)
                        </button>
                        <a href="/products" class="btn btn-outline-secondary">
                            Tiếp tục mua sắm
                        </a>
                    </div>

                    <!-- Trust Badges -->
                    <div class="mt-4 pt-3 border-top">
                        <div class="small text-muted text-center">
                            <div class="mb-2">
                                <i class="bi bi-shield-check text-success"></i>
                                Thanh toán an toàn
                            </div>
                            <div>
                                <i class="bi bi-truck text-primary"></i>
                                Giao hàng toàn quốc
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function formatCurrency(amount) {
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount).replace('₫', 'đ');
            }

            function toggleSelectAll() {
                const selectAll = document.getElementById('selectAll');
                const checkboxes = document.querySelectorAll('.item-checkbox');
                checkboxes.forEach(cb => cb.checked = selectAll.checked);
                updateTotal();
            }

            function updateQuantity(itemId, change) {
                // Get current quantity
                var qtySpan = document.getElementById('qty-' + itemId);
                var currentQty = parseInt(qtySpan.innerText);
                var newQty = currentQty + change;

                // Get Max Stock from data attribute
                var qtyGroup = document.getElementById('qty-group-' + itemId);
                var maxStock = parseInt(qtyGroup.getAttribute('data-max'));
                var warningDiv = document.getElementById('stock-warning-' + itemId);

                // Check Minimum (Don't update if < 1)
                if (newQty < 1) return;

                // Check Maximum
                if (newQty > maxStock) {
                    // Show Inline Warning
                    if (warningDiv) warningDiv.classList.remove('d-none');

                    // Show Error Modal
                    document.getElementById('errorMessage').innerText = "Lỗi: Không đủ hàng trong kho. Còn lại: " + maxStock;
                    var errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                    errorModal.show();
                    return; // Stop execution
                }

                // If decreasing below max, hide warning
                if (newQty < maxStock && warningDiv) {
                    warningDiv.classList.add('d-none');
                }

                // If exactly at max, show warning (per user request)
                if (newQty === maxStock && warningDiv) {
                    warningDiv.classList.remove('d-none');
                }

                // Call AJAX
                var formData = new FormData();
                formData.append('quantity', newQty);

                fetch('/cart/update/' + itemId, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update DOM
                            qtySpan.innerText = data.newQuantity;

                            // Update Checkbox Data Attribute
                            var checkbox = document.querySelector('.item-checkbox[value="' + itemId + '"]');
                            if (checkbox) {
                                checkbox.setAttribute('data-qty', data.newQuantity);
                            }

                            // Update Total if this item is selected
                            updateTotal();
                        } else {
                            // Fallback: Show error modal
                            document.getElementById('errorMessage').innerText = data.message;
                            var errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                            errorModal.show();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }

            function updateTotal() {
                const checkboxes = document.querySelectorAll('.item-checkbox:checked');
                let total = 0;
                let count = 0;

                checkboxes.forEach(cb => {
                    const price = parseFloat(cb.getAttribute('data-price'));
                    const qty = parseInt(cb.getAttribute('data-qty'));
                    total += price * qty;
                    count++;
                });

                document.getElementById('subTotalDisplay').innerText = formatCurrency(total);
                document.getElementById('finalTotalDisplay').innerText = formatCurrency(total);

                const btn = document.getElementById('checkoutBtn');
                btn.innerText = `THANH TOÁN (${count})`;

                if (count > 0) {
                    btn.disabled = false;
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-danger'); // Red color when active
                } else {
                    btn.disabled = true;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-secondary'); // Gray color when disabled
                }

                // Update Select All state based on individual checks
                const allCheckboxes = document.querySelectorAll('.item-checkbox');
                document.getElementById('selectAll').checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
            }

            function submitCheckout() {
                // Here we would gather IDs and submit to checkout
                const selectedIds = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value);
                if (selectedIds.length > 0) {
                    window.location.href = '/checkout?ids=' + selectedIds.join(',');
                }
            }

            // Run check on load to reset state
            document.addEventListener('DOMContentLoaded', updateTotal);
        </script>

        <style>
            /* Progress Steps */
            .steps {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }

            .step-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
                color: #999;
                font-size: 14px;
            }

            .step-item.active {
                color: #000;
                font-weight: bold;
            }

            .step-circle {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: #f0f0f0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                border: 2px solid #ddd;
            }

            .step-item.active .step-circle {
                background: #000;
                color: #fff;
                border-color: #000;
            }

            .step-line {
                width: 60px;
                height: 2px;
                background: #ddd;
                margin: 0 10px;
            }

            /* Card Box */
            .card-box {
                background: #fff;
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            }

            /* Cart Item */
            .cart-item-card {
                transition: all 0.2s;
            }

            .cart-item-card:hover {
                background: #f9f9f9;
                border-radius: 8px;
                padding: 12px;
                margin: -12px;
            }

            .cart-item-image {
                width: 100px;
                height: 100px;
                object-fit: cover;
            }

            /* Quantity Controls */
            .quantity-controls button {
                width: 32px;
                height: 32px;
                padding: 0;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                border-radius: 4px;
            }

            /* Sticky Summary */
            .sticky-summary {
                position: sticky;
                top: 100px;
            }

            /* Responsive */
            @media (max-width: 991px) {
                .sticky-summary {
                    position: relative;
                    top: 0;
                }

                .cart-item-image {
                    width: 80px;
                    height: 80px;
                }
            }

            /* Custom Circular Checkbox (TikTok Style) */
            .form-check-input {
                width: 22px;
                height: 22px;
                border-radius: 50% !important;
                /* Force circular */
                border: 2px solid #ccc;
                cursor: pointer;
                margin-top: 0;
                /* Center align */
            }

            .form-check-input:checked {
                background-color: #dc3545;
                /* Bootstrap danger red */
                border-color: #dc3545;
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='M6 10l3 3l6-6'/%3e%3c/svg%3e");
            }

            .form-check-input:focus {
                box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
            }
        </style>

        <!-- Confirm Clear Modal -->
        <div class="modal fade" id="confirmClearModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-0">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center pt-0 pb-4">
                        <div class="mb-3 text-danger">
                            <i class="bi bi-exclamation-circle" style="font-size: 3rem;"></i>
                        </div>
                        <h5 class="fw-bold mb-3">Xóa giỏ hàng?</h5>
                        <p class="text-muted mb-4">Bạn có chắc chắn muốn xóa tất cả sản phẩm khỏi giỏ hàng không? Hành
                            động này không thể hoàn tác.</p>

                        <div class="d-flex justify-content-center gap-3">
                            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Không</button>
                            <button type="button" class="btn btn-danger px-4"
                                onclick="document.getElementById('clearCartForm').submit()">Đồng ý xóa</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notification Scripts & Styles -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var toast = document.getElementById('successToast');
                if (toast) {
                    // Slide In
                    setTimeout(function () {
                        toast.style.transform = 'translateX(0)';
                    }, 100);

                    // Slide Out after 3 seconds
                    setTimeout(function () {
                        hideToast();
                    }, 3100);
                }
            });

            function hideToast() {
                var toast = document.getElementById('successToast');
                if (toast) {
                    toast.style.transform = 'translateX(-120%)';
                    // Remove from DOM after animation
                    setTimeout(function () {
                        toast.remove();
                    }, 500);
                }
            }
        </script>

        <style>
            #successToast {
                position: fixed;
                top: 100px;
                /* Adjust based on header height */
                left: 20px;
                z-index: 9999;
                min-width: 300px;
                max-width: 400px;
                transform: translateX(-120%);
                /* Start hidden off-screen */
                transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                /* Bouncy effect */
                border-radius: 12px;
                border-left: 5px solid #198754;
            }
        </style>

        <!-- Error/Warning Modal -->
        <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-0">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center pt-0 pb-4">
                        <div class="mb-3 text-warning">
                            <i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem;"></i>
                        </div>
                        <h5 class="fw-bold mb-3">Thông báo</h5>
                        <p id="errorMessage" class="text-muted mb-4">Nội dung lỗi...</p>

                        <div class="d-flex justify-content-center">
                            <button type="button" class="btn btn-dark px-4" data-bs-dismiss="modal">Đã hiểu</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </article>
</body>

</html>