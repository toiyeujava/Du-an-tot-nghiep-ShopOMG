<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{fragments/layout :: view(~{::title}, ~{::article})}">

<head>
    <title>Đăng ký tài khoản</title>
</head>

<body>
    <article class="container py-5">
        <style>
            /* Style cho form đăng ký */
            .register-card {
                max-width: 500px;
                margin: 0 auto;
                border: none;
                box-shadow: 0 0 20px rgba(0,0,0,0.05);
                border-radius: 12px;
                overflow: hidden;
            }
            .register-header {
                background: #000;
                color: #fff;
                padding: 30px 20px;
                text-align: center;
            }
            .form-control:focus {
                box-shadow: none;
                border-color: #000;
            }
            
            /* Style cho các điều kiện mật khẩu */
            .validation-item {
                font-size: 0.85rem;
                color: #6c757d;
                transition: all 0.3s;
                margin-bottom: 4px;
                display: flex;
                align-items: center;
            }
            .validation-item i {
                font-size: 0.6rem;
                margin-right: 8px;
                transition: all 0.3s;
            }
            /* Khi thoả mãn điều kiện */
            .validation-item.valid {
                color: #198754; /* Màu xanh lá */
                font-weight: 500;
            }
            .validation-item.valid i {
                color: #198754;
                transform: scale(1.2);
            }
            
            /* Nút mắt ẩn/hiện */
            .btn-toggle-pass {
                border-color: #ced4da;
                border-left: none;
                background: #fff;
                color: #6c757d;
            }
            .btn-toggle-pass:hover {
                background: #f8f9fa;
                color: #000;
            }
            .form-control-pass {
                border-right: none;
            }
        </style>

        <div class="card register-card">
            <div class="register-header">
                <h3 class="fw-bold mb-1">Đăng ký tài khoản</h3>
                <p class="small opacity-75 mb-0">Trở thành thành viên của ShopOMG ngay hôm nay</p>
            </div>
            
            <div class="card-body p-4">
                <div th:if="${error}" class="alert alert-danger text-center small py-2 mb-3" role="alert">
                    <i class="fas fa-exclamation-circle me-1"></i> <span th:text="${error}"></span>
                </div>

                <form th:action="@{/account/sign-up}" th:object="${form}" method="post" id="registerForm">
                    
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-uppercase text-muted">Họ và tên</label>
                        <input type="text" class="form-control" th:field="*{fullName}" placeholder="Nhập họ tên của bạn">
                        <small class="text-danger" th:if="${#fields.hasErrors('fullName')}" th:errors="*{fullName}"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-uppercase text-muted">Email</label>
                        <input type="email" class="form-control" th:field="*{email}" placeholder="example@email.com">
                        <small class="text-danger" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-uppercase text-muted">Tên đăng nhập</label>
                        <input type="text" class="form-control" th:field="*{username}" placeholder="Chọn tên đăng nhập">
                        <small class="text-danger" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-uppercase text-muted">Mật khẩu</label>
                        <div class="input-group">
                            <input type="password" class="form-control form-control-pass" id="password" th:field="*{password}" placeholder="Nhập mật khẩu" onkeyup="checkPasswordStrength()">
                            <button class="btn btn-toggle-pass" type="button" onclick="togglePassword('password', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        
                        <div class="mt-2 ps-1" id="password-rules">
                            <div class="validation-item" id="rule-length">
                                <i class="fas fa-circle"></i> Tối thiểu 8 ký tự
                            </div>
                            <div class="validation-item" id="rule-case">
                                <i class="fas fa-circle"></i> Chữ hoa & chữ thường
                            </div>
                            <div class="validation-item" id="rule-special">
                                <i class="fas fa-circle"></i> Số và ký tự đặc biệt (@$!%*?&)
                            </div>
                        </div>
                        
                        <small class="text-danger" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label small fw-bold text-uppercase text-muted">Xác nhận mật khẩu</label>
                        <div class="input-group">
                            <input type="password" class="form-control form-control-pass" id="confirmPassword" th:field="*{confirmPassword}" placeholder="Nhập lại mật khẩu" onkeyup="checkConfirmPassword()">
                            <button class="btn btn-toggle-pass" type="button" onclick="togglePassword('confirmPassword', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="validation-item mt-1 ps-1 d-none" id="rule-match">
                            <i class="fas fa-circle"></i> Mật khẩu khớp
                        </div>
                        <small class="text-danger" th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}"></small>
                    </div>

                    <button type="submit" class="btn btn-dark w-100 fw-bold py-2 mb-3">ĐĂNG KÝ NGAY</button>

                    <div class="text-center small">
                        <span class="text-muted">Đã có tài khoản?</span> 
                        <a href="/login" class="text-dark fw-bold ms-1">Đăng nhập</a>
                    </div>
                </form>
            </div>
        </div>

        <script>
            // 1. Hàm ẩn/hiện mật khẩu
            function togglePassword(fieldId, btn) {
                const input = document.getElementById(fieldId);
                const icon = btn.querySelector('i');
                
                if (input.type === "password") {
                    input.type = "text";
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = "password";
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            }

            // 2. Hàm kiểm tra độ mạnh mật khẩu Real-time
            function checkPasswordStrength() {
                const password = document.getElementById("password").value;
                
                // Các quy tắc (Regex)
                const minLength = password.length >= 8;
                const hasCase = /[a-z]/.test(password) && /[A-Z]/.test(password);
                
                // [ĐÃ SỬA]: Điều kiện VÀ (&&) thay vì HOẶC (||)
                // Phải có ít nhất 1 số VÀ 1 ký tự đặc biệt
                const hasSpecialAndNumber = /[0-9]/.test(password) && /[@$!%*?&]/.test(password);

                // Cập nhật giao diện
                updateRuleStatus("rule-length", minLength);
                updateRuleStatus("rule-case", hasCase);
                updateRuleStatus("rule-special", hasSpecialAndNumber);

                // Kiểm tra lại confirm password nếu đang nhập
                checkConfirmPassword();
            }

            // Helper để đổi màu xanh/xám
            function updateRuleStatus(elementId, isValid) {
                const el = document.getElementById(elementId);
                const icon = el.querySelector('i');
                
                if (isValid) {
                    el.classList.add("valid");
                    icon.classList.remove("fa-circle");
                    icon.classList.add("fa-check-circle");
                } else {
                    el.classList.remove("valid");
                    icon.classList.remove("fa-check-circle");
                    icon.classList.add("fa-circle");
                }
            }

            // 3. Hàm kiểm tra mật khẩu xác nhận
            function checkConfirmPassword() {
                const password = document.getElementById("password").value;
                const confirm = document.getElementById("confirmPassword").value;
                const ruleMatch = document.getElementById("rule-match");

                if (confirm.length > 0) {
                    ruleMatch.classList.remove("d-none");
                    if (password === confirm) {
                        ruleMatch.classList.add("valid");
                        ruleMatch.innerHTML = '<i class="fas fa-check-circle me-2"></i>Mật khẩu trùng khớp';
                    } else {
                        ruleMatch.classList.remove("valid");
                        ruleMatch.innerHTML = '<i class="fas fa-times-circle me-2 text-danger"></i>Chưa khớp';
                    }
                } else {
                    ruleMatch.classList.add("d-none");
                }
            }
        </script>
    </article>
</body>
</html>